   1:			;
   2:			;********************************************************
   3:			;*							*
   4:			;*	    UNIVERSAL BASIC I/O SYSTEM (BIOS)		*
   5:			;*		       Vers. 1.8			*
   6:			;*							*
   7:			;*     A,B = 5 Inc. 32,10 sec/trk 256 byte/sec		*
   8:			;*     C,D = 5 Inc. 32,10 sec/trk 256 byte/sec		*
   9:			;*     E,F = 5 Inc. 17 sec/trk	  128 byte/sec (old Lg)	*
  10:			;*							*
  11:			;*    nota: aggiungere diagnostica errori in fdd i/o	*
  12:			;*							*
  13:			;********************************************************
  14:			;
  15:				title	Bios 2.0 for NE CP/M 2.2 with Hard-Disk Basf 6188
  16:			;	subttl	Copyright Studio Lg, Genova - Last rev 15/08/1984 09:06
  17:			;	Programmers: Martino Stefano & Gallarani Paolo
  18:			;
  19:				; Disassembly/retype Piergiorgio Betti & Pino Giaquinto 2015/04/25
  20:				;
  21:				include sysent.asm		; read in os allocation
sysent.asm
**** sysent.asm ****
   1:			;
   2:			;********************************************************
   3:			;*							*
   4:			;*	    UNIVERSAL BASIC I/O SYSTEM (BIOS)		*
   5:			;*							*
   6:			;*           memory size and SONE allocation		*
   7:			;*							*
   8:			;********************************************************
   9:			;
  10:			;	Programmers: Martino Stefano & Gallarani Paolo
  11:				; Disassembly/retype Pino Giaquinto & Piergiorgio Betti 2015/04/25
  12:			;
  13:			;********************************************************
  14:			;*		MEMORY SIZING				*
  15:			;********************************************************
  16:			;
  17:			; msize	equ	56			; CP/M memory size in kilobyte
  18:				include	msize.asm		; read in ram size
msize.asm
**** msize.asm ****
   1:	003C          	msize	equ	60
**** sysent.asm ****
  19:	0001          	mres	equ	1			; reserved mem in kilobyte
  20:			;
  21:			;********************************************************
  22:			;*		SYSTEM CONSTANTS			*
  23:			;********************************************************
  24:			;
  25:	003B          	cmsize	equ	msize-mres		; cp/m size in kbyte
  26:			;
  27:			;	bias is address offset from 3400h for memory system
  28:			;	than 16k (referred to as "b" throughout the next)
  29:			;
  30:	9C00          	bias	equ	(cmsize-20)*1024;
  31:	D000          	ccp	equ	3400h+bias		; base of ccp
  32:	D800          	bdose	equ	ccp+800h		; start of bdos
  33:	D806          	bdos	equ	ccp+806h		; base of bdos
  34:	E600          	bios	equ	ccp+1600h		; base of bios
  35:	1000          	ipl	equ	1000h			; ipl origin
  36:			;
  37:			; EOF
**** bios20h.asm ****
  22:				include const.asm		; read in system constants
const.asm
**** const.asm ****
   1:			;
   2:			;********************************************************
   3:			;*							*
   4:			;*	    UNIVERSAL BASIC I/O SYSTEM (BIOS)		*
   5:			;*							*
   6:			;*                  system constants           		*
   7:			;*							*
   8:			;********************************************************
   9:			;
  10:			;	Programmers: Martino Stefano & Gallarani Paolo
  11:				; Disassembly/retype Pino Giaquinto & Piergiorgio Betti 2015/04/25
  12:			;
  13:	4853          	vers	equ	('H'*256)+'S'		; Single side version
  14:	0014          	rev	equ	20			; CBIOS revision number
  15:			;
  16:			;
  17:			;	Boolean scalar constants
  18:	0000          	false	equ	0
  19:	FFFF          	true	equ	not false
  20:			;
  21:			;
  22:			; ***	I/O Devices	***
  23:	0001          	TTY	equ	01b			; CON:
  24:	0000          	RDR	equ	false			; Undefinited
  25:	0000          	PUN	equ	false			; Undefinited
  26:	0002          	LST	equ	10b			; LST:
  27:			;
  28:			;	Default Value for I/O byte
  29:	0081          	DftI.O	equ	(LST shl 6) or (RDR shl 4) or (PUN shl 2) or (TTY)
  30:			;
  31:			;
  32:			;
  33:			;********************************************************
  34:			;*							*
  35:			;*		ASCII EQUIVALENTS			*
  36:			;*							*
  37:			;********************************************************
  38:			;
  39:	0087          	bell	equ	'G'+'@'			; ring beeper
  40:	0088          	backsp	equ	'H'+'@'			; back space char.
  41:	0089          	tab	equ	'I'+'@'			; tabulation char.
  42:	008A          	lf	equ	'J'+'@'			; line-feed char.
  43:	008C          	ffeed	equ	'L'+'@'			; form feed char.
  44:	008D          	cr	equ	'M'+'@'			; carriage-return char.
  45:	0093          	pfx	equ	'S'+'@'			; attributes pfx
  46:	0048          	rever	equ	'H'			; Reverse On	(^SH)
  47:	0043          	flash	equ	'C'			; Flash On	(^SC)
  48:	0040          	norm	equ	'@'			; Normal	(^S@)
  49:	0020          	spc	equ	' '			; space char.
  50:	0024          	endmsg	equ	'$'			; end of print message
  51:			;
  52:			;
  53:			;
  54:			;********************************************************
  55:			;*							*
  56:			;*		Rom routines address			*
  57:			;*							*
  58:			;********************************************************
  59:			;
  60:	F000          	rom	equ	0F000h			; <--- rom starting address
  61:	F003          	cin	equ	rom+3			; console input
  62:	F006          	cout	equ	rom+6			; console output
  63:	F009          	csts	equ	rom+9			; console status
  64:	F00C          	lout	equ	rom+12			; printer output
  65:	F00F          	lsts	equ	rom+15			; printer status
  66:	F012          	fdios	equ	rom+18			; fdd I/O 128 byte
  67:	F015          	fdiod	equ	rom+21			; fdd I/O 256 byte
  68:	F018          	wdini	equ	rom+24			; wdd initialization
  69:	F01B          	wdio	equ	rom+27			; wdd I/O 256 byte
  70:	F01E          	strout	equ	rom+30			; print string .DE until $
  71:			; print	equ	strout			; sinonime
  72:	F021          	bootrom	equ	rom+33			; load BIOS and go to wboote
  73:	F024          	printat	equ	rom+36			; print str. -> DE at -> HL cursor
  74:	F027          	movcurs	equ	rom+39			; move cursor at -> HL
  75:	F02A          	vidinit	equ	rom+42			; initialize video
  76:	F02D          	CompFlg	equ	rom+45			; Version Number
  77:			;
  78:			;
  79:			;
  80:			;********************************************************
  81:			;*		SYSTEM CONSTANTS			*
  82:			;********************************************************
  83:			;
  84:	0000          	asmcpm	equ	false			; *** include and assemble cp/m ***
  85:			;
  86:	1600          	cpml	equ	bios-ccp		; lenght (in bytes) of cp/m system (ccp + bdos)
  87:	0600          	biosl	equ	600h			; lenght (in bytes) of standard bios
  88:	0016          	cpmsiz	equ	16h			; cpml/secsiz = lenght (sector num.) of cp/m (ccp + bdos)
  89:	0006          	biossiz	equ	06h			; biosl/secsiz = lenght (sector num.) of bios
  90:	0003          	iobyte	equ	0003h			; intel I/O byte
  91:	0004          	CurDsk	equ	0004h			; cp/m logical disk number
  92:	0080          	stack	equ	0080h			; wboot stack pointer
  93:	0080          	defldma	equ	0080h			; cp/m default dma adrs
  94:	1000          	stack1	equ	1000h			; ipl stack pointer
  95:			;
  96:			;
  97:			;********************************************************
  98:			;*							*
  99:			;*		Disk constants				*
 100:			;*							*
 101:			;********************************************************
 102:			;
 103:	0002          	fddsiz	equ	2			; fdd number on system (10 sec/trk -256 byte-)
 104:	0002          	wddsiz	equ	2			; wdd number on system (32 sec/trk -256 byte-)
 105:	0002          	extfds	equ	2			; fds number on system (17 sec/trk -128 byte-)
 106:	0006          	maxdsk	equ	fddsiz+wddsiz+extfds	; max disk on system
 107:			;
 108:	000A          	fddsec	equ	10			; fdd sec/trk (10)
 109:	0020          	wddsec	equ	32			; wdd sec/trk (32)
 110:	0100          	secsiz	equ	256			; byte/sector (256)
 111:			;
 112:	0002          	cpmblk	equ	secsiz/128		; r/w buffer size
 113:	0001          	secmsk	equ	cpmblk-1		; sector mask
 114:	0014          	fddspt	equ	fddsec*cpmblk		; cp/m fdd sec/trk (20)
 115:	0040          	wddspt	equ	wddsec*cpmblk		; cp/m wdd sec/trk (64)
 116:			;
 117:			;
 118:			;
 119:			;********************************************************
 120:			;*							*
 121:			;*	BDOS constants on entry to write		*
 122:			;*							*
 123:			;********************************************************
 124:			;
 125:	0000          	wrall	equ	0			; write to allocated
 126:	0001          	wrdir	equ	1			; write to directory
 127:	0002          	wrual	equ	2			; write to unallocated
 128:			;
**** bios20h.asm ****
  23:			;
  24:			;
  25:			;********************************************************
  26:			;*							*
  27:			;*	    UNIVERSAL BASIC I/O SYSTEM (BIOS)		*
  28:			;*		       Vers. 2.0			*
  29:			;*							*
  30:			;*                     System IPL			*
  31:			;*							*
  32:			;********************************************************
  33:			;
  34:			; 	subttl	IPL for NE BIOS 2.0 with Hard-Disk BASF 6188
  35:			;	Programmers: Martino Stefano & Gallarani Paolo
  36:			;
  37:			;
  38:			;********************************************************
  39:			;*							*
  40:			;*		IPL for NEW BIOS			*
  41:			;*							*
  42:			;********************************************************
  43:			;
  44:			;	this program loaded in ram by rom boot, load the cp/m
  45:			;	bios, set bios sysflag and go to wboote
  46:			;
  47:			;
  48:			;	subttl	IPL for NE BIOS 1.8 with Hard-Disk BASF 6188
  49:			;
  50:				aseg
  51:	1000          		.phase ipl			; origin of IPL
  52:			;
  53:			;
  54:	1000          	wdbboot:
  55:				; entry point for bios boot from hard disk
  56:	1000  C30910  		jp	wdbbt1			; jump to hard bios boot
  57:			;
  58:	1003          	fdbboot:
  59:				; entry point for bios boot from floppy disk
  60:	1003  C33A10  		jp	fdbbt1			; jump to floppy bios boot
  61:	1006          	iplmsg:
  62:				; message for ipl checking
  63:	1006  49504C  		defb	'IPL'
  64:			;
  65:			;
  66:	1009          	wdbbt1:
  67:				; load bios from hard disk
  68:	1009  213D10  		ld	hl,bbtdsk		; H.L = bios boot r/w para pointer
  69:	100C  CD1BF0  		call	wdio			; read bios
  70:	100F  B7      		or	a			; read error ?
  71:	1010  201B    		jr	nz,bbterr		; yes, then reinitialize system
  72:								; A = 0 because not error occurs
  73:	1012          	bbtok:
  74:				; bios has been loaded
  75:	1012  3250EA  		ld	(sysflag),a		; set bios system flag
  76:	1015  DD2151EA		ld	ix,vidareas		; init video table
  77:	1019  CD2AF0  		call	vidinit
  78:	101C  210300  		ld	hl,iobyte		; point to iobyte
  79:	101F  3681    		ld	(hl),DftI.O		; value for i/o byte (lst:=lpt:)
  80:	1021  23      		inc	hl			; point to logdsk
  81:	1022  3600    		ld	(hl),0			; set cp/m logical disk = 0
  82:	1024  114B10  		ld	de,cpmmsg		; D.E = cp/m message
  83:	1027  CD1EF0  		call	strout			; print it
  84:	102A  C303E6  		jp	wboote			; jump to bios wboote
  85:				;
  86:				; error in reading BIOS
  87:				;
  88:	102D          	bbterr:
  89:	102D  118110  		ld	de,bbtermsg		; D.E = bios boot error message
  90:	1030  CD1EF0  		call	strout			; print it
  91:	1033          		wait1cr:
  92:	1033  CD03F0  		call	cin			; wait one char.
  93:	1036  FE8D    		cp	cr			; cr ?
  94:	1038  20F9    		jr	nz,wait1cr		;
  95:				;
  96:	103A          	fdbbt1:
  97:	103A  C321F0  		jp	bootrom			; load IPL from FDD ?
  98:			;
  99:			;
 100:				; bios boot r/w para table (initially for wdd)
 101:			;
 102:	103D  00      	bbtdsk:	defb	0			; dsk-0 sid 0
 103:	103E  0000    	bbttrk:	defw	0			; cylinder number
 104:	1040  18      	bbtsec:	defb	24			; secor number (for wdd)
 105:	1041  00E6    	bbtdma:	defw	bios			; bios start address
 106:	1043  00      	btprw:	defb	0			; read operation
 107:			;
 108:	1044  06      	wdbloc:	defb	biossiz			; for wdd boot (6 sec. to load)
 109:			;
 110:	1045          	bbtxlt:
 111:				; sector translate table for floppy disk (256 byte/sec)
 112:				; the first two sector are occuped by ccp + bdos
 113:				; than bbtxlt starts at 4' sector
 114:				;
 115:	1045  09050208		defb	9,5,2,8,4,10
	      040A
 116:			;
 117:	104B          	cpmmsg:
 118:	104B  8C8D8A8A		defb	ffeed,cr,lf,lf,pfx,'H',(cmsize+1)/10+'0',(cmsize+1) mod 10+'0','K N.E. New Disk System - '
	      93483630
	      4B204E2E
	      452E204E
	      65772044
	      69736B20
	      53797374
	      656D202D
	      20
 119:	106C  76657273		defb	'vers ',high vers,low vers
	      204853
 120:	1073  20726576		defb	' rev ',rev/10+'0','.',rev mod 10+'0',pfx,'@'
	      20322E30
	      9340
 121:	107D  8D8A8724		defb	cr,lf,bell,endmsg
 122:			;
 123:			;
 124:	1081          	bbtermsg:
 125:	1081  878D8A43		defb	bell,cr,lf,'Cannot load your BIOS.'
	      616E6E6F
	      74206C6F
	      61642079
	      6F757220
	      42494F53
	      2E
 126:	109A  8D8A5365		defb	cr,lf,'Set new system diskette in disk A,'
	      74206E65
	      77207379
	      7374656D
	      20646973
	      6B657474
	      6520696E
	      20646973
	      6B20412C
 127:			;
 128:	10BE .. 10FF 00		defs	wdbboot+256-$	; free space on IPL ram
 129:			;
 130:	0100          		.dephase
 131:			;
 132:			;********************************************************
 133:			;*							*
 134:			;*		CP/M 2 Operating System			*
 135:			;*							*
 136:			;********************************************************
 137:			;
 138:	0000          	if asmcpm
 140:			endif
 141:			;
 142:			;********************************************************
 143:			;*							*
 144:			;*			BIOS				*
 145:			;*							*
 146:			;********************************************************
 147:			;
 148:			;	jump vector for individual subroutines
 149:			;
 150:	E600          		.phase	bios		; origin of this program
 151:			;
 152:	E600  C317E7  		jp	boot		; cold start
 153:	E603          	wboote:
 154:	E603  C31DE7  		jp	wboot		; warm start
 155:	E606  C3DCE7  		jp	const		; console status
 156:	E609  C3E8E7  		jp	conin		; console character in
 157:	E60C  C3F9E7  		jp	conout		; console character out
 158:	E60F  C30EE8  		jp	listd		; list character out
 159:	E612  C32AE8  		jp	punch		; punch character out
 160:	E615  C32BE8  		jp	reader		; reader character in
 161:	E618  C35FE8  		jp	home		; move head to home position
 162:	E61B  C33EE8  		jp	seldsk		; select disk
 163:	E61E  C362E8  		jp	settrk		; set track number
 164:	E621  C373E8  		jp	setsec		; set sector number
 165:	E624  C378E8  		jp	setdma		; set dma address
 166:	E627  C37DE8  		jp	read		; read disk
 167:	E62A  C382E8  		jp	write		; write disk
 168:	E62D  C31CE8  		jp	listst		; return list status
 169:	E630  C367E8  		jp	sectran		; sector translate
 170:			;
 171:			;
 172:			;
 173:			;********************************************************
 174:			;* D P B T A B L E					*
 175:			;*							*
 176:			;*	W/F  Size  B/S   S/T  Trk  Hds  R/T  Capacity	*
 177:			;* -	--- ------ ---   --   ---  ---  --- ---------	*
 178:			;* A: = wdd   5"   256	 32   360			*
 179:			;* B: = wdd   5"   256	 32   360			*
 180:			;* C: = fdd   5"   256	 10				*
 181:			;* D: = fdd   5"   256	 10				*
 182:			;* E: = fdd   5"   128	 17				*
 183:			;* F: = fdd   5"   128	 17				*
 184:			;*							*
 185:			;********************************************************
 186:			;
 187:			;
 188:	E633          	dpbase	equ	$	; base of disk parameter header
 189:			;
 190:				; dpe0,dpe1 = disk parameter header for hard disk
 191:	E633          	dpe0:
 192:	E633  00000000		defw	xlt0, 0000h	; no translate table
 193:	E637  00000000		defw	0000h, 0000h	; scratch area
 194:	E63B  00EDCCE6		defw	dirbuf, dpb0	; dir buff, parm block
 195:	E63F  91EEDCED		defw	csv0, alv0	; check, alloc vector
 196:	E643          	dpe1:
 197:	E643  00000000		defw	xlt0, 0000h	; no translate table
 198:	E647  00000000		defw	0000h, 0000h	; scratch area
 199:	E64B  00EDDBE6		defw	dirbuf, dpb01	; dir buff, parm block
 200:	E64F  46EF91EE		defw	csv1, alv1	; check, alloc vector
 201:			;
 202:				; dpe2,dpe3 = disk parameter header for floppy disk (256 byte/sec)
 203:	E653          	dpe2:	; 256 byte/sec - Single Side
 204:	E653  93E60000		defw	xlt1, 0000h	; translate table
 205:	E657  00000000		defw	0000h, 0000h	; scratch area
 206:	E65B  00EDEAE6		defw	dirbuf,dpb1	; dir buff,parm block
 207:	E65F  8CED80ED		defw	csv2,alv2	; check,alloc vector
 208:				;
 209:	E663          	dpe3:	; 256 byte/sec - Single Side
 210:	E663  93E60000		defw	xlt1,0000h	; translate table
 211:	E667  00000000		defw	0000h,0000h	; scratch area
 212:	E66B  00EDF9E6		defw	dirbuf,dpb12	; dir buff,parm block
 213:	E66F  A8ED9CED		defw	csv3,alv3	; check,alloc vector
 214:			;
 215:				; dpe4,dpe5 = disk parameter header for floppy disk (128 byte/sec)
 216:	E673          	dpe4:	; 128 byte/sec - Single Side
 217:	E673  BBE60000		defw	xlt2,0000h	; translate table
 218:	E677  00000000		defw	0000h,0000h	; scratch area
 219:	E67B  00ED08E7		defw	dirbuf,dpb2	; dir buff,parm block
 220:	E67F  C2EDB8ED		defw	csv4,alv4	; check,alloc vector
 221:				;
 222:	E683          	dpe5:	; 128 byte/sec - Single Side
 223:	E683  BBE60000		defw	xlt2,0000h	; translate table
 224:	E687  00000000		defw	0000h,0000h	; scratch area
 225:	E68B  00ED08E7		defw	dirbuf,dpb2	; dir buff,parm block
 226:	E68F  D4EDCAED		defw	csv5,alv5	; check,alloc vector
 227:			;
 228:			;
 229:	0000          	xlt0	equ	0		; no sector translate for hard disk
 230:			;
 231:	E693          	xlt1:
 232:				; sector translate table for floppy disk (256 byte/sec)
 233:	E693  01020D0E		defb	1,2,13,14,5,6,17,18,9,10,3,4,15,16,7,8,19,20,11,12
	      05061112
	      090A0304
	      0F100708
	      13140B0C
 234:	E6A7  15162122		defb	21,22,33,34,25,26,37,38,29,30,23,24,35,36,27,28,39,40,31,32
	      191A2526
	      1D1E1718
	      23241B1C
	      27281F20
 235:			;
 236:	E6BB          	xlt2:
 237:				; sector translate table for floppy disk (128 byte/sec)
 238:	E6BB  01070D02		defb	1,7,13,2,8,14,3,9,15
	      080E0309
	      0F
 239:	E6C4  040A1005		defb	4,10,16,5,11,17,6,12
	      0B11060C
 240:			;
 241:			;
 242:	E6CC          	dpb0:
 243:				; disk parameter block for hard disk 0 (256 byte/sector 1 res. trk)
 244:	E6CC  8000    		defw	128		; SPT (sec/trk) (32 sect * (256/128) * 2 side)
 245:	E6CE  05      		defb	5		; BSH
 246:	E6CF  1F      		defb	31		; BLM
 247:	E6D0  01      		defb	1		; EXM (extent mask)
 248:	E6D1  9B05    		defw	1435		; DSM (disk size in BLS units - 1) (5740 kbyte)
 249:	E6D3  FF03    		defw	1023		; DRM (directory elements - 1)
 250:	E6D5  FF      		defb	11111111b	; AL0
 251:	E6D6  00      		defb	00000000b	; AL1
 252:	E6D7  0000    		defw	0		; CKS disk fixed, no dir. check vector
 253:	E6D9  0100    		defw	1		; OFF (track offset)
 254:			;
 255:	E6DB          	dpb01:
 256:				; disk parameter block for hard disk 1 (256 byte/sector no res. trk)
 257:	E6DB  8000    		defw	128		; SPT (sec/trk) (32 sect * (256/128) * 2 side)
 258:	E6DD  05      		defb	5		; BSH
 259:	E6DE  1F      		defb	31		; BLM
 260:	E6DF  01      		defb	1		; EXM (extent mask)
 261:	E6E0  9F05    		defw	1439		; DSM (disk size in BLS units - 1) (5756 kbyte)
 262:	E6E2  FF03    		defw	1023		; DRM (directory elements - 1)
 263:	E6E4  FF      		defb	11111111b	; AL0
 264:	E6E5  00      		defb	00000000b	; AL1
 265:	E6E6  0000    		defw	0		; CKS disk fixed, no dir. check vector
 266:	E6E8  0000    		defw	0		; OFF (track offset)
 267:			;
 268:			;
 269:	E6EA          	dpb1:
 270:				; disk parameter block for floppy disk
 271:				; 256 byte/sector - Single Side
 272:	E6EA  1400    		defw	20		; SPT (sec/trk) (10 sect * (256/128) * 1 side)
 273:	E6EC  04      		defb	4		; BSH
 274:	E6ED  0F      		defb	15		; BLM
 275:	E6EE  01      		defb	1		; EXM (extent mask)
 276:	E6EF  2D00    		defw	45		; DSM (disk size in BLS unit) (90 kbyte)
 277:	E6F1  3F00    		defw	63		; DRM (directory elements - 1)
 278:	E6F3  80      		defb	10000000b	; AL0
 279:	E6F4  00      		defb	00000000b	; AL1
 280:	E6F5  1000    		defw	16		; CKS = (DRM + 1)/4 (size dir. check vect.)
 281:	E6F7  0300    		defw	3		; OFF (track offset)
 282:			;
 283:	E6F9          	dpb12:
 284:				; disk parameter block for floppy disk
 285:				; 256 byte/sector - Single Side
 286:	E6F9  2800    		defw	40		; SPT (sec/trk) (10 sect * (256/128))
 287:	E6FB  04      		defb	4		; BSH
 288:	E6FC  0F      		defb	15		; BLM
 289:	E6FD  01      		defb	1		; EXM (extent mask)
 290:	E6FE  5E00    		defw	94		; DSM (disk size in BLS unit) (90 kbyte)
 291:	E700  3F00    		defw	63		; DRM (directory elements - 1)
 292:	E702  80      		defb	10000000b	; AL0
 293:	E703  00      		defb	00000000b	; AL1
 294:	E704  1000    		defw	16		; CKS = (DRM + 1)/4 (size dir. check vect.)
 295:	E706  0200    		defw	2		; OFF (track offset)
 296:			;
 297:			;
 298:	E708          	dpb2:
 299:				; disk parameter block for floppy disk (128 byte/sector)
 300:	E708  1100    		defw	17		; SPT (SEC/trk)
 301:	E70A  03      		defb	3		; BSH
 302:	E70B  07      		defb	7		; BLM
 303:	E70C  00      		defb	0		; EXM (extent mask)
 304:	E70D  4D00    		defw	77		; DSM (disk size in BLS unit) (77 kbyte)
 305:	E70F  1F00    		defw	31		; DRM (directory elements - 1)
 306:	E711  80      		defb	10000000b	; AL0
 307:	E712  00      		defb	00000000b	; AL1
 308:	E713  0800    		defw	8		; CKS = (DRM + 1)/4 (size dir. check vect.)
 309:	E715  0300    		defw	3		; OFF (track offset)
 310:			;
 311:			;
 312:			;
 313:			;********************************************************
 314:			;* B O O T						*
 315:			;*		Exec a Cold Boot			*
 316:			;********************************************************
 317:			;
 318:	E717          	boot:
 319:				; set A = sysflag and go to bootrom
 320:	E717  3A50EA  		ld	a,(sysflag)	; if A = 0 then load IPL from WDD
 321:	E71A  C321F0  		jp      bootrom		; else from FDD
 322:			;
 323:			;
 324:			;
 325:			;********************************************************
 326:			;* W B O O T						*
 327:			;*		Load bdos + ccp				*
 328:			;*		From wdd or Single/Side Fdd		*
 329:			;********************************************************
 330:			;
 331:	E71D          	wboot:
 332:	E71D  318000  		ld	sp,stack	; set stack pointer
 333:	E720  CD41E9  		call	WrtPng		; Write any pending sector
 334:	E723  210400  		ld	hl,CurDsk	; point to cp/m log disk
 335:	E726  7E      		ld	a,(hl)		; load cp/m logical disk
 336:	E727  E60F    		and     00001111b	; mask out User
 337:	E729  FE06    		cp	maxdsk		; disk overflow ?
 338:	E72B  3802    		jr	c,wb_1		; no, then go to wboot
 339:	E72D          	wb_0:
 340:	E72D  3600    		ld	(hl),0		; else clear cp/m log disk
 341:							; H=0
 342:	E72F          	wb_1:
 343:				; Set parameter,
 344:				; then load from Hard or Floppy Disk
 345:	E72F  210000  		ld	hl,0		; HL=0
 346:	E732  227BEA  		ld	(PrePhy),hl	; Dsk 0 - side 0 & low Track=0
 347:	E735  2602    		ld	h,2		; Sector #2
 348:	E737  227DEA  		ld	(PreTrk+1),hl	; Set High Trk=0 & Sector #2
 349:	E73A  2616    		ld	h,cpmsiz	; ccp + bdos size in sector number
 350:	E73C  2281EA  		ld	(PreR.W),hl	; set Read op. and # of sec (for wdd)
 351:	E73F  2100D0  		ld	hl,ccp		; Cp/m starting add
 352:	E742  227FEA  		ld	(PreDma),hl	; set it
 353:				;
 354:				; Hard or Floppy ?
 355:				;
 356:	E745  3A50EA  		ld	a,(sysflag)	; load system flag
 357:	E748  B7      		or	a		; sysflag = 0 ?
 358:	E749  200B    		jr	nz,fd_wb	; no, load from floppy
 359:	E74B          	wd_wb:
 360:				; load from hard disk
 361:	E74B  217BEA  		ld	hl,PrePhy	; H.L = wdd boot para adrs
 362:	E74E  CD1BF0  		call	wdio		; call wdd read
 363:	E751  B7      		or	a		; wdd i/o error ?
 364:	E752  207F    		jr	nz,exboot	; yes, then retry
 365:	E754  182C    		jr	syschk		; no, then go to system check
 366:			;
 367:	E756          	fd_wb:
 368:				; load cp/m from floppy disk
 369:	E756  0616    		ld	b,cpmsiz	; ccp + bdos size in sector number
 370:	E758  11CAE7  		ld	de,wbxlt+1	; D.E = sector translate table
 371:	E75B          	fd_wb.3:
 372:	E75B  C5      		push	bc		; save sector count
 373:	E75C  D5      		push	de		; save xlt1 pointer
 374:	E75D  1A      		ld	a,(de)		; load physical sector
 375:	E75E  327EEA  		ld	(PreSec),a	; set physical sector number
 376:	E761  217BEA  		ld	hl,PrePhy	; H.L = boot para adrs
 377:	E764  CD15F0  		call	fdiod		; read 256 byte
 378:	E767  D1      		pop	de		;
 379:	E768  C1      		pop	bc		;
 380:	E769  B7      		or	a		; read error ?
 381:	E76A  2067    		jr	nz,exboot	; yes, then retry
 382:	E76C  2180EA  		ld	hl,PreDma+1	; HL = high current dma adrs
 383:	E76F  34      		inc	(hl)		; DMA=DMA+256
 384:	E770  05      		dec	b		; warm boot end ?
 385:	E771  280F    		jr	z,syschk	; yes, then go to system check
 386:	E773  13      		inc	de		; xlt1 pointer + 1
 387:	E774  7B      		ld	a,e		;
 388:	E775  FED3    		cp	low (wbxlt+fddsec); end of track ?
 389:	E777  20E2    		jr	nz,fd_wb.3	; no, load next sector
 390:	E779  217CEA  		ld	hl,PreTrk	; H.L = track para adrs
 391:	E77C  34      		inc	(hl)		;track = track + 1
 392:	E77D  11C9E7  		ld	de,wbxlt	; point to start xlt table
 393:	E780  18D9    		jr	fd_wb.3		; load first sector to next track
 394:				;
 395:				; CP/M has been loaded
 396:	E782          	syschk:
 397:				; cp/m system check
 398:	E782  3A02D0  		ld	a,(ccp+2)	; load third data of cp/m
 399:	E785  FED3    		cp	high (ccp+35Ch)	; check for correct jp andress
 400:	E787  204A    		jr	nz,exboot	; no, error
 401:	E789  3EC3    		ld	a,0c3h		; jump command
 402:	E78B  320000  		ld	(0000),a	; location 0000h
 403:	E78E  2103E6  		ld	hl,wboote	; wboot address
 404:	E791  220100  		ld	(0001),hl	;
 405:	E794  320500  		ld	(0005),a	; location 0005h
 406:	E797  2106D8  		ld	hl,bdos		; bdos address
 407:	E79A  220600  		ld	(0006),hl	;
 408:	E79D  3EFF    		ld	a,0ffh		; A = 0ffh
 409:	E79F  327AEA  		ld	(PreDsk),a	; Physic disk para -> 'ff'
 410:	E7A2  2100EC  		ld	hl,defbuf	; Default Buffer
 411:	E7A5  227FEA  		ld	(PreDma),hl	; set it
 412:	E7A8  018000  		ld	bc,defldma	; BC = default dma adrs
 413:	E7AB  CD78E8  		call	setdma		; cp/m dma = 0080h
 414:	E7AE  3A0400  		ld	a,(CurDsk)	; load cp/m Default disk
 415:	E7B1  4F      		ld	c,a		;
 416:	E7B2  C300D0  		jp	ccp		; and jump to ccp
 417:				;
 418:	E7B5 .. E7C8 00		defs	20		; free space
 419:			;
 420:	E7C9          	wbxlt:
 421:	E7C9  01070309		defb	1,7,3,9,5,2,8,4,10,6
	      05020804
	      0A06
 422:			;
 423:			;
 424:	E7D3          	exboot:
 425:	E7D3          	exbot1:
 426:	E7D3  11BAE9  		ld	de,nosysmsg	; D.E = no system message
 427:	E7D6  CDAFE9  		call	msgcr		; print it and wait cr
 428:	E7D9  C32FE7  		jp	wb_1		; retry boot
 429:			;
 430:			;
 431:			;
 432:			;********************************************************
 433:			;*							*
 434:			;*	*** Logical Peripheral Device Sub ***		*
 435:			;*							*
 436:			;********************************************************
 437:			;
 438:			;
 439:			;********************************************************
 440:			;* C o n S t						*
 441:			;*	Return console status (A=-1 if char ready)	*
 442:			;********************************************************
 443:			;
 444:	E7DC          	const:
 445:	E7DC  3A0300  		ld	a,(iobyte)	; load intel i/o byte
 446:	E7DF  E603    		and	00000011b	; mask bit 0,1
 447:	E7E1  FE02    		cp	2		;
 448:	E7E3  DA09F0  		jp	c,csts		; jump rom console status
 449:	E7E6  1848    		jr	notdev		; jump no device
 450:			;
 451:			;
 452:			;********************************************************
 453:			;* C o n I n						*
 454:			;*	Read char from console				*
 455:			;********************************************************
 456:			;
 457:	E7E8          	conin:
 458:	E7E8  3A0300  		ld	a,(iobyte)	; load intel i/o byte
 459:	E7EB  E603    		and	00000011b	; mask bit 0,1
 460:	E7ED  FE02    		cp	2		;
 461:	E7EF  303F    		jr	nc,notdev	; >1, no device
 462:							;
 463:	E7F1  DDE5    		push	IX		; preserve IX for Z80's prgm
 464:	E7F3  CD03F0  		call	cin		; rom console input
 465:	E7F6  DDE1    		pop	IX		; restore
 466:	E7F8  C9      		ret			; done
 467:			;
 468:			;
 469:			;********************************************************
 470:			;* C o n O u t						*
 471:			;*	Write C caracter on console			*
 472:			;********************************************************
 473:			;
 474:	E7F9          	conout:
 475:	E7F9  3A0300  		ld	a,(iobyte)	; load intel i/o byte
 476:	E7FC  E603    		and	00000011b	; mask bit 0,1
 477:	E7FE  FE02    		cp	2		; >1, then
 478:	E800  302E    		jr	nc,notdev	; jump no device
 479:							;
 480:	E802  DDE5    		push	IX		; Save
 481:	E804  FDE5    		push	IY		;	Register
 482:	E806  CD06F0  		call	cout		; call console output
 483:	E809  FDE1    		pop	IY		; Restore
 484:	E80B  DDE1    		pop	IX		;	Registers
 485:	E80D  C9      		ret			; done
 486:			;
 487:			;
 488:			;
 489:			;********************************************************
 490:			;*	P R I N T E R   S u b r o u t i n e		*
 491:			;********************************************************
 492:			;
 493:			;
 494:			;********************************************************
 495:			;* L i s t						*
 496:			;*	Write C caracter on printer			*
 497:			;********************************************************
 498:			;
 499:	E80E          	listd:
 500:	E80E  3A0300  		ld	a,(iobyte)	; load intel i/o byte
 501:	E811  E6C0    		and	11000000b	; mask bit 6,7
 502:	E813  FE80    		cp	080h		;
 503:	E815  DA06F0  		jp	c,cout		; jump rom console output
 504:	E818  CA0CF0  		jp	z,lout		; jump printer output
 505:	E81B  C9      		ret			; no device, data lost
 506:			;	jr	notdev		; jump no device
 507:			;
 508:			;********************************************************
 509:			;* L i s t S t						*
 510:			;*	Return printer status				*
 511:			;********************************************************
 512:			;
 513:	E81C          	listst:
 514:	E81C  3A0300  		ld	a,(iobyte)	; load intel i/o byte
 515:	E81F  E6C0    		and	11000000b	; mask bit 6,7
 516:	E821  FE80    		cp	080h		;
 517:	E823  DA09F0  		jp	c,csts		; jump rom console status
 518:	E826  CA0FF0  		jp	z,lsts		; jump printer status
 519:	E829  C9      		ret			; no device, now ret 11000000b
 520:				;jr	notdev		; jump no device
 521:			;
 522:			;
 523:			;
 524:			;********************************************************
 525:			;* S E R I A L   D E V I C E S   S u b r o u t i n e	*
 526:			;********************************************************
 527:			;
 528:			;
 529:			;********************************************************
 530:			;* P u n c h						*
 531:			;*	Puncher output					*
 532:			;********************************************************
 533:			;
 534:	E82A          	punch:
 535:	0000          		if	PUN		; if PUNcher exists
 545:				else			; no puncher devices
 546:	E82A  C9      		ret			; data lost
 547:				endif
 548:			;
 549:			;
 550:			;********************************************************
 551:			;* R e a d e r						*
 552:			;*	Reader input					*
 553:			;********************************************************
 554:			;
 555:	E82B          	reader:
 556:	0000          		if	RDR		; if ReaDeR exists
 565:				ELSE			; if no device
 566:	E82B  00      		nop			;
 567:	E82C  00      		nop			;
 568:	E82D  3E1A    		ld	a,'Z'-'@'	; set ^z = EOF
 569:	E82F  C9      		ret			; end
 570:				endif
 571:			;
 572:	E830          	notdev:
 573:				; print not device message and go to cpm
 574:	E830  3E81    		ld	a,DftI.O	; set default i/o byte
 575:	E832  320300  		ld	(iobyte),a	;
 576:	E835  113FEA  		ld	de,ndevmsg	; D.E = no device msg
 577:	E838  CD1EF0  		call	strout		; print it
 578:	E83B  C31DE7  		jp	wboot		; return to cp/m
 579:			;
 580:			;
 581:			;
 582:			;********************************************************
 583:			;*		Disk I/O Subroutine			*
 584:			;********************************************************
 585:			;
 586:			;
 587:			;********************************************************
 588:			;* S e l D s k						*
 589:			;*		Select logical disk from reg. C		*
 590:			;*		Ret HL=.DPB or 0 if error		*
 591:			;********************************************************
 592:			;
 593:	E83E          	SelDsk:
 594:	E83E  210000  		ld	hl,0		; return 0000h if error
 595:	E841  79      		ld	a,c		;
 596:	E842  FE06    		cp	maxdsk		; too large ?
 597:	E844  D0      		ret	nc		; leave HL = 0000
 598:			;
 599:	E845  3A50EA  		ld	a,(sysflag)	; load system flag
 600:	E848  B7      		or	a		; if system flag = 0 then disk
 601:	E849  79      		ld	a,c		;	 restore disk # on a
 602:	E84A  2806    		jr	z,SDsk.1	; A,B = hard disk; C,D = floppy disk
 603:	E84C  FE04    		cp	wddsiz+fddsiz	; Disk # > D:
 604:	E84E  3002    		jr	nc,SDsk.1	; yes, no exchange
 605:	E850  EE02    		xor	00000010b	; A,B -> C,D and vice-versa
 606:							; A,B = floppy disk; C,D = hard disk
 607:	E852          	SDsk.1:
 608:	E852  3272EA  		ld	(LogDsk),a	; set logical disk number
 609:	E855  6F      		ld	l,a		; L = disk number
 610:	E856  29      		add	hl,hl		; HL = disk number * 16
 611:	E857  29      		add	hl,hl		; HL = disk number * 16
 612:	E858  29      		add	hl,hl		; HL = disk number * 16
 613:	E859  29      		add	hl,hl		; HL = disk number * 16
 614:	E85A  1133E6  		ld	de,dpbase	;
 615:	E85D  19      		add	hl,de		;H.L disk table adrs
 616:	E85E  C9      		ret
 617:			;
 618:			;
 619:			;********************************************************
 620:			;* H O M E						*
 621:			;*		Select logical track 0			*
 622:			;********************************************************
 623:			;
 624:	E85F          	Home:
 625:	E85F  010000  		ld	bc,0		; Track #0000
 626:			;
 627:			;
 628:			;********************************************************
 629:			;* S e t T r k						*
 630:			;*		Select logical track from reg.s BC	*
 631:			;********************************************************
 632:			;
 633:	E862          	SetTrk:
 634:			;
 635:	E862  ED4374EA		ld	(LogTrk),bc	; Save low and high byte
 636:	E866  C9      		ret			;
 637:			;
 638:			;
 639:			;********************************************************
 640:			;* S e t T r a n					*
 641:			;*		Translate the BC sector using trans	*
 642:			;*		table pointed by DE			*
 643:			;********************************************************
 644:			;
 645:	E867          	SecTran:
 646:	E867  EB      		ex	de,hl		; H.L = sectran table adrs
 647:	E868  7D      		ld	a,l		; check for -> 0000
 648:	E869  B4      		or	h		; this means no sec tran
 649:	E86A  09      		add	hl,bc		; compute sector (BC = sec num)
 650:	E86B  2804    		jr	z,Strn_5	; no sec tran
 651:	E86D  6E      		ld	l,(hl)		; get trans sector
 652:	E86E  2600    		ld	h,0		; high = 0
 653:	E870  C9      		ret			; done
 654:	E871          	Strn_5:
 655:	E871  2C      		inc	l		; convert to base 1
 656:	E872  C9      		ret
 657:			;
 658:			;
 659:			;********************************************************
 660:			;* S e t S e c						*
 661:			;*		Set sector from registers BC		*
 662:			;********************************************************
 663:			;
 664:	E873          	SetSec:
 665:	E873  79      		ld	a,c		; Only low byte
 666:	E874  3271EA  		ld	(LogSec),a	; because sector < 256
 667:	E877  C9      		ret			;
 668:			;
 669:			;
 670:			;********************************************************
 671:			;* S e t D M A						*
 672:			;*		Set DMA address from registers BC	*
 673:			;********************************************************
 674:			;
 675:	E878          	SetDMA:
 676:	E878  ED4377EA		ld	(LogDMA),bc	; set logical DMA
 677:	E87C  C9      		ret
 678:			;
 679:			;
 680:			;********************************************************
 681:			;* R e a d						*
 682:			;*		Read sector specified by prev param	*
 683:			;*		@ spec DMA (ret A=-1 if error)		*
 684:			;********************************************************
 685:			;
 686:	E87D          	read:
 687:	E87D  AF      		xor	a		; set disk read operation
 688:	E87E  0E02    		ld	c,wrual		; write type (to unallocated)
 689:	E880  1802    		jr	rw00		;
 690:			;
 691:			;
 692:			;********************************************************
 693:			;* W r i t e						*
 694:			;*		Write sector specified by prev param	*
 695:			;*		from spec DMA (ret A=-1 if error)	*
 696:			;********************************************************
 697:			;
 698:	E882          	write:
 699:	E882  3E01    		ld	a,1		; set write operation
 700:	E884          	rw00:
 701:	E884  3279EA  		ld	(LogR.W),a	; set read or write operation
 702:	E887  1172EA  		ld	de,LogDsk	; DE. LogDsk
 703:	E88A  1A      		ld	a,(de)		; A = Logical Disk number
 704:	E88B  FE04    		cp	wddsiz+fddsiz	; check for 256 byte/sec dsk
 705:	E88D  3831    		jr	c,RW256		; yes, jump to it
 706:			;
 707:			;
 708:			;********************************************************
 709:			;* R W 1 2 8	- 	Read o Write 128 byte/sec dsk	*
 710:			;*		Write pending sectors			*
 711:			;*		just read or write sector		*
 712:			;*		set no sector buffered			*
 713:			;********************************************************
 714:			;
 715:	E88F          	RW128:
 716:	E88F  E601    		and	1		; mask bit 1 for unit select
 717:	E891  3273EA  		ld	(PhyDsk),a	; set Disk Unit & Side 0
 718:	E894  CD41E9  		call	WrtPng		; Write Pending Sectors
 719:	E897  3A71EA  		ld	a,(LogSec)	;
 720:	E89A  3276EA  		ld	(PhySec),a	; Physical sector = Logical
 721:	E89D          	RW128.1:
 722:	E89D  2173EA  		ld	hl,PhyDsk	; Point to Operation Table
 723:	E8A0  CD12F0  		call	fdios		; read o write 128 byte
 724:	E8A3  217AEA  		ld	hl,PreDsk	; Point to Sector Buffered tbl
 725:	E8A6  36FF    		ld	(hl),0ffh	; set no sector buffered
 726:	E8A8  B7      		or	a		;fdd i/o error ?
 727:	E8A9  C8      		ret	z		; no, then normal return
 728:	E8AA  11FEE9  		ld	de,ioerrmsg	; D.E = Disk err message
 729:	E8AD  CD1EF0  		call	strout		; print it
 730:	E8B0  CD03F0  		call	cin		; wait one char.
 731:	E8B3  FE8D    		cp	cr		; is return ?
 732:	E8B5  28E6    		jr	z,RW128.1	; yes, then retry
 733:	E8B7  FE03    		cp	'C'-'@'		; is cntrl C ?
 734:	E8B9  CA1DE7  		jp	z,wboot		; yes, wboot
 735:	E8BC  3E01    		ld	a,1		; Set error
 736:	E8BE  B7      		or	a		; set flag
 737:	E8BF  C9      		ret			; ret with operation status on A
 738:			;
 739:			;
 740:			;********************************************************
 741:			;* R W 2 5 6	- 	Read o Write 256 byte/sec dsk	*
 742:			;********************************************************
 743:			;
 744:	E8C0          	RW256:
 745:	E8C0  2640    		ld	h,wddspt	; if disk number is 0 or 1
 746:	E8C2  FE02    		cp	wddsiz		; then H = wdd sector/track
 747:	E8C4  3802    		jr	c,R256.1	;
 748:	E8C6  2614    		ld	h,fddspt	; else H = fdd sector/track
 749:	E8C8          	R256.1:
 750:	E8C8  79      		ld	a,c		; get &
 751:	E8C9  3284EA  		ld	(WrType),a	; set CP/M write type
 752:	E8CC  1B      		dec	de		; DE. LogSec
 753:	E8CD  1A      		ld	a,(de)		; Get Logical Sector
 754:	E8CE  3D      		dec	a		; to base 0
 755:	E8CF  2E00    		ld	l,0		; initial side = 0
 756:	E8D1          	R256.2:
 757:	E8D1  BC      		cp	h		; repeat until
 758:	E8D2  3804    		jr	c,R256.3	; log sec < sec /trk
 759:	E8D4  2C      		inc	l		; side up
 760:	E8D5  94      		sub	h		; log sec = log sec - sec/trk
 761:	E8D6  18F9    		jr	R256.2		; retry
 762:	E8D8          		R256.3:
 763:	E8D8  B7      		or	a		;carry = 0
 764:	E8D9  1F      		rra			; A = A/2
 765:	E8DA  3C      		inc	a		; to base 1
 766:	E8DB  3276EA  		ld	(PhySec),a	; Set physical sector
 767:	E8DE  CB25    		sla	l		; to bit 4
 768:	E8E0  CB25    		sla	l		; to bit 4
 769:	E8E2  CB25    		sla	l		; to bit 4
 770:	E8E4  CB25    		sla	l		; to bit 4
 771:	E8E6  13      		inc	de		; DE.LogDsk
 772:	E8E7  1A      		ld	a,(de)		; get LogDsk
 773:	E8E8  E601    		and	1		; only unit number
 774:	E8EA  B5      		or	l		; merge side
 775:	E8EB  3273EA  		ld	(PhyDsk),a	; set unit and side
 776:				;
 777:	E8EE  0605    		ld	b,5		; byte count for old-new para compare
 778:							; D.E => CP/M	Disk para (new)
 779:	E8F0  217AEA  		ld	hl,PreDsk	; H.L =>	Disk para (old)
 780:	E8F3          	rw01:
 781:				; compare old para with new para (dsk,sid,trk,sec)
 782:	E8F3  1A      		ld	a,(de)		; A = new para
 783:	E8F4  BE      		cp	(hl)		; (hl) = old para
 784:	E8F5  2006    		jr	nz,wtchk	; new <> old
 785:	E8F7  23      		inc	hl		; next para adrs
 786:	E8F8  13      		inc	de		;
 787:	E8F9  10F8    		djnz	rw01		; repeat until end para
 788:	E8FB  1814    		jr	match		; dsk, sid,trk,sec,equ
 789:	E8FD          	wtchk:
 790:	E8FD  CD41E9  		call	WrtPng		; Write Pending Sectors
 791:	E900  C0      		ret	nz		; return if error
 792:				;
 793:	E901  010500  		ld	bc,5		; 5 parameters
 794:	E904  2172EA  		ld	hl,LogDsk	; H.L = new para adrs
 795:	E907  117AEA  		ld	de,PreDsk	; D.E = old para adrs
 796:	E90A  EDB0    		ldir			; new para -> old para
 797:	E90C  CD4DE9  		call	diskrd		; disk read
 798:	E90F  B7      		or	a		; read error ?
 799:	E910  C0      		ret	nz		; error return
 800:	E911          	match:
 801:	E911  3A71EA  		ld	a,(LogSec)	; load logical sector
 802:	E914  3D      		dec	a		; convert to base 0
 803:	E915  E601    		and	secmsk		; sector mask
 804:	E917  67      		ld	h,a
 805:	E918  2E00    		ld	l,0		; get high or low buff adrs
 806:	E91A  CB3C    		srl	h		; HL=HL*128=(*256)/2
 807:	E91C  CB1D    		rr	l
 808:	E91E  1100EC  		ld	de,defbuf	; D.E = phys sector buff start adrs
 809:	E921  19      		add	hl,de		; H.L = log sector buff start adrs
 810:	E922  ED5B77EA		ld	de,(LogDma)	; D.E = user dma adrs
 811:	E926  018000  		ld	bc,128		; BC = moving count
 812:	E929  3A79EA  		ld	a,(LogR.W)	; load r/w flag
 813:	E92C  B7      		or	a		; read ?
 814:	E92D  2804    		jr	z,rwbuf		;
 815:	E92F  3283EA  		ld	(WrtFlg),a	; write flag on (A=1)
 816:	E932  EB      		ex	de,hl		; H.L = user dma adrs
 817:	E933          	rwbuf:
 818:	E933  EDB0    		ldir			; move (hl) to (de)
 819:	E935  3A84EA  		ld	a,(WrType)	; load write type
 820:	E938  FE01    		cp	wrdir		; directory write ?
 821:	E93A  3E00    		ld	a,0		; prepare no errors
 822:	E93C  CC41E9  		call	z,WrtPng	; yes, write Phys sector
 823:	E93F  B7      		or	a		; set flags
 824:	E940  C9      		ret			; return status (A)
 825:			;
 826:			;
 827:			;********************************************************
 828:			;* W r t P n g						*
 829:			;*		Check for pending Sectors		*
 830:			;*		Write if active				*
 831:			;********************************************************
 832:			;
 833:	E941          	WrtPng:
 834:	E941  2183EA  		ld	hl,WrtFlg
 835:	E944  7E      		ld	a,(hl)		; get flag
 836:	E945  3600    		ld	(hl),0		; & clear
 837:	E947  B7      		or	a		; was active ?
 838:	E948  C8      		ret	z		; no, return
 839:	E949  CD50E9  		call	diskwt		; yes, write flush data
 840:	E94C  C9      		ret			; return status & flag
 841:			;
 842:			;
 843:			;********************************************************
 844:			;* D i s k R d						*
 845:			;*		Read Physical Sector			*
 846:			;********************************************************
 847:			;
 848:	E94D          	diskrd:
 849:				; disk read
 850:	E94D  AF      		xor	a		; 0 = read
 851:	E94E  1802    		jr	rdwt
 852:			;
 853:			;
 854:			;********************************************************
 855:			;* D i s k W t						*
 856:			;*		Write Physical Sector			*
 857:			;********************************************************
 858:			;
 859:	E950          	diskwt:
 860:				; disk write
 861:	E950  3E01    		ld	a,1		; 1 = write
 862:	E952          		rdwt:
 863:	E952  3281EA  		ld	(PreR.W),a	; set r/w para
 864:	E955          	rdwt0:
 865:	E955  217BEA  		ld	hl,PrePhy	; H.L = i/o para adrs
 866:	E958  3A7AEA  		ld	a,(PreDsk)	; load i/o unit number
 867:	E95B  FE02    		cp	wddsiz		; wdd i/o ?
 868:	E95D  3015    		jr	nc,fdrdwt	; no, then fdd i/o
 869:	E95F          	wdrdwt:
 870:	E95F  3E01    		ld	a,1		; one sector to wdd i/o
 871:	E961  3282EA  		ld	(PreBlk),a	; set wdd sector block
 872:	E964  CD1BF0  		call	wdio		; exec. wdd i/o
 873:	E967  B7      		or	a		; i/o error ?
 874:	E968  C8      		ret	z		; no, then normal return
 875:	E969  CD8DE9  		call	SendErr		; Print Error Code
 876:				;
 877:	E96C          	NoBuff:
 878:	E96C          	rdwterr:
 879:	E96C  3EFF    		ld	a,0ffh		; set no sector buffered
 880:	E96E  327AEA  		ld	(PreDsk),a	;
 881:	E971  E601    		and	1		; A=1
 882:	E973  C9      		ret
 883:	E974          	fdrdwt:
 884:	E974          	fdrw1:
 885:	E974  CD15F0  		call	fdiod		; r/w 256 byte
 886:	E977          	fdrw2:
 887:	E977  B7      		or	a		; fdd i/o error ?
 888:	E978  C8      		ret	z		; no, then normal return
 889:	E979  11FEE9  		ld	de,ioerrmsg	; D.E = Disk err message
 890:	E97C  CD1EF0  		call	strout		; print it
 891:	E97F  CD03F0  		call	cin		; wait one char.
 892:	E982  FE8D    		cp	cr		; is return ?
 893:	E984  28CF    		jr	z,rdwt0		; yes, then retry
 894:	E986  FE03    		cp	'C'-'@'		; is cntrl C ?
 895:	E988  20E2    		jr	nz,NoBuff	; Set Error and no sector buff
 896:	E98A  C303E6  		jp	wboote		; else go to wboot
 897:			;
 898:			;
 899:			;
 900:			;********************************************************
 901:			;*		Send Error Message on console		*
 902:			;********************************************************
 903:			;
 904:	E98D          	SendErr:
 905:	E98D  F5      		push	af		; save character
 906:	E98E  0F      		rrca			; get 4 msb's
 907:	E98F  0F      		rrca			; get 4 msb's
 908:	E990  0F      		rrca			; get 4 msb's
 909:	E991  0F      		rrca			; get 4 msb's
 910:	E992  CDA6E9  		call	HxChar		; print 4 msb's
 911:	E995  32F8E9  		ld	(ErrHig),a	; store high Error code
 912:	E998  F1      		pop	af		; get 4 lsb's
 913:	E999  CDA6E9  		call	HxChar		;
 914:	E99C  32F9E9  		ld	(ErrLow),a	; store low Error code
 915:	E99F  11EEE9  		ld	de,ErrMsg	;
 916:	E9A2  CD1EF0  		call	strout		; print it
 917:	E9A5  C9      		ret			;done
 918:				;
 919:				; Convert A low nibble in Hex ASCII Char
 920:				;
 921:	E9A6          	HxChar:
 922:	E9A6  E60F    		and	0Fh		; keep 4 lsb's
 923:	E9A8  C690    		add	a,90h		; develop a supplement of 6
 924:	E9AA  27      		daa			; and carry
 925:	E9AB  CE40    		adc	a,'@'		; sum ASCII offset
 926:	E9AD  27      		daa			;
 927:	E9AE  C9      		ret
 928:			;
 929:			;
 930:			;
 931:	E9AF          	msgcr:
 932:				; print string pointed by DE and wait cr
 933:	E9AF  CD1EF0  		call	strout		; print it
 934:	E9B2          	waitcr:
 935:	E9B2  CD03F0  		call	cin		; wait one char.
 936:	E9B5  FE8D    		cp	cr		; cr ?
 937:	E9B7  20F9    		jr	nz,waitcr	;
 938:	E9B9  C9      		ret
 939:			;
 940:			;
 941:			;
 942:			;********************************************************
 943:			;*							*
 944:			;*		Initialized RAM data areas		*
 945:			;*							*
 946:			;********************************************************
 947:			;
 948:	E9BA          	nosysmsg:
 949:	E9BA  8D8A8753		defb	cr,lf,bell,'Set system diskette in disk A,',cr,lf
	      65742073
	      79737465
	      6D206469
	      736B6574
	      74652069
	      6E206469
	      736B2041
	      2C8D8A
 950:	E9DD  6F6B2070		defb	'ok push return. ',endmsg
	      75736820
	      72657475
	      726E2E20
	      24
 951:			;
 952:	E9EE          	ErrMsg:
 953:	E9EE  8D8A8745		defb	cr,lf,bell,'Error #'
	      72726F72
	      2023
 954:	E9F8  30      	ErrHig:	defb	'0'
 955:	E9F9  30      	ErrLow:	defb	'0'
 956:	E9FA  202D2024		defb	' - ',endmsg
 957:			;
 958:			;
 959:	E9FE          	ioerrmsg:
 960:	E9FE  8D8A8744		defb	cr,lf,bell,'DISK I/O ERROR',cr,lf
	      49534B20
	      492F4F20
	      4552524F
	      528D8A
 961:	EA11  3C524554		defb	'<RETURN> retry, ^C abort, any key to continue'
	      55524E3E
	      20726574
	      72792C20
	      5E432061
	      626F7274
	      2C20616E
	      79206B65
	      7920746F
	      20636F6E
	      74696E75
	      65
 962:	EA3E  24      		defb	endmsg
 963:			;
 964:	EA3F          	ndevmsg:
 965:	EA3F  8D8A872E		defb	cr,lf,bell,'.NO Device.',cr,lf,endmsg
	      4E4F2044
	      65766963
	      652E8D8A
	      24
 966:			;
 967:			;
 968:			;
 969:			;********************************************************
 970:			;*		B i o s   INPUT/OUTPUT   Tables		*
 971:			;********************************************************
 972:			;
 973:	EA50          	sysflag:
 974:	EA50  00      		defb	0		; system flag for disk assignement
 975:			;
 976:	EA51          	vidareas:
 977:				; video routine data areas
 978:	EA51 .. EA70 00		defs	32
 979:			;
 980:			; Logical Parameter Table
 981:			;
 982:	EA71  01      	LogSec:	defb	1		; CP/M logical Sector number
 983:	EA72  00      	LogDsk:	defb	0		; CP/M logical Disk number
 984:	EA73  00      	PhyDsk:	defb	0		; Physical Disk Number
 985:	EA74  0000    	LogTrk:	defw	0000		; Physical Track Number
 986:	EA76  01      	PhySec:	defb	1		; Physical Sector Number
 987:	EA77  8000    	LogDma:	defw	0080h		; CP/M logical Dma address
 988:	EA79  00      	LogR.W:	defb	0		; CP/M logical R/W Flag
 989:			;
 990:			; Previous Parameter Table
 991:			;
 992:	EA7A  FF      	PreDsk:	defb	0ffh		; Previous CP/M Disk
 993:	EA7B  00      	PrePhy:	defb	0		; Previous Phys Disk
 994:	EA7C  0000    	PreTrk:	defw	0000		; Previous Phys=Logical Track
 995:	EA7E  01      	PreSec:	defb	1		; Previous Phys Sector
 996:	EA7F  00EC    	PreDma:	defw	defbuf		; Physical DMA add
 997:	EA81  00      	PreR.W:	defb	0		; Phys R/W operation
 998:	EA82  01      	PreBlk:	defb	1		; Phys # of Sectors (for wdd)
 999:	EA83  00      	WrtFlg:	defb	0		; Write Pending Flag
1000:	EA84  01      	Wrtype:	defb	1		; BDos Write Type
1001:			;
1002:			;
1003:	EA85 .. EBFF 00		defs	bios+600h-$		; free space on bios ram
1004:			;
1005:			;
1006:			;
1007:			;********************************************************
1008:			;*							*
1009:			;*		Disk data areas				*
1010:			;*							*
1011:			;********************************************************
1012:			;
1013:	EC00 .. ECFF 00	defbuf:	defs	secsiz		; default i/o dma address
1014:	ED00 .. ED7F 00	dirbuf:	defs	128		; directory buffer
1015:			;
1016:			;
1017:			;********************************************************
1018:			;*		Allocation and check vectors		*
1019:			;********************************************************
1020:			;
1021:	ED80 .. ED8B 00	alv2:	defs	12		; alloc vector 2
1022:	ED8C .. ED9B 00	csv2:	defs	16		; check vector 2
1023:			;
1024:	ED9C .. EDA7 00	alv3:	defs	12		; alloc vector 3
1025:	EDA8 .. EDB7 00	csv3:	defs	16		; check vector 3
1026:			;
1027:			;
1028:				; extfdd alloc and check vector
1029:			;
1030:	EDB8 .. EDC1 00	alv4:	defs	10		; alloc vector 4
1031:	EDC2 .. EDC9 00	csv4:	defs	8		; check vector 4
1032:			;
1033:	EDCA .. EDD3 00	alv5:	defs	10		; alloc vector 5
1034:	EDD4 .. EDDB 00	csv5:	defs	8		; check vector 5
1035:			;
1036:				; wdd alloc and check vector
1037:			;
1038:	EDDC .. EE90 00	alv0:	defs	181		; alloc vector 0 (1440K/8)+1
1039:			csv0:	defs	0		; no check vector 0
1040:			;
1041:	EE91 .. EF45 00	alv1:	defs	181		; alloc vector 1 (1440K/8)+1
1042:			csv1:	defs	0		; no check vector 1
1043:			;
1044:	EF46 .. EFFF 00		defs	bios+0a00h-$	; free space
1045:			;
1046:	0B00          		.dephase		; end of bios + data areas
1047:			; 	end 100h
1048:	0B00          		end



Statistics:

     5	passes
     0	jr promotions
   197	symbols
     0	bytes



Symbol Table:

alv0            eddc     errhig          e9f8     rdwt            e952     
alv1            ee91     errlow          e9f9     rdwt0           e955     
alv2            ed80     errmsg          e9ee     rdwterr         e96c+    
alv3            ed9c     exboot          e7d3     read            e87d     
alv4            edb8     exbot1          e7d3+    reader          e82b     
alv5            edca     extfds         =   2+    rev            =  14+    
asmcpm         =   0+    false          =   0+    rever          =  48+    
backsp         =  88+    fd_wb           e756     rom            =f000+    
bbtdma          1041+    fd_wb.3         e75b     rw00            e884     
bbtdsk          103d     fdbboot         1003+    rw01            e8f3     
bbtermsg        1081     fdbbt1          103a     rw128           e88f+    
bbterr          102d     fddsec         =   a+    rw128.1         e89d     
bbtok           1012+    fddsiz         =   2+    rw256           e8c0     
bbtsec          1040+    fddspt         =  14+    rwbuf           e933     
bbttrk          103e+    fdiod          =f015+    sdsk.1          e852     
bbtxlt          1045+    fdios          =f012+    secmsk         =   1+    
bdos           =d806+    fdrdwt          e974     secsiz         = 100+    
bdose          =d800+    fdrw1           e974+    sectran         e867     
bell           =  87+    fdrw2           e977+    seldsk          e83e     
bias           =9c00+    ffeed          =  8c+    senderr         e98d     
bios           =e600+    flash          =  43+    setdma          e878     
biosl          = 600+    home            e85f     setsec          e873     
biossiz        =   6+    hxchar          e9a6     settrk          e862     
boot            e717     iobyte         =   3+    spc            =  20+    
bootrom        =f021+    ioerrmsg        e9fe     stack          =  80+    
btprw           1043+    ipl            =1000+    stack1         =1000+    
ccp            =d000+    iplmsg          1006+    strn_5          e871     
cin            =f003+    lf             =  8a+    strout         =f01e+    
cmsize         =  3b+    listd           e80e     syschk          e782     
compflg        =f02d+    listst          e81c     sysflag         ea50     
conin           e7e8     logdma          ea77     tab            =  89+    
conout          e7f9     logdsk          ea72     true           =ffff+    
const           e7dc     logr.w          ea79     tty            =   1+    
cout           =f006+    logsec          ea71     vers           =4853+    
cpmblk         =   2+    logtrk          ea74     vidareas        ea51     
cpml           =1600+    lout           =f00c+    vidinit        =f02a+    
cpmmsg          104b     lst            =   2+    wait1cr         1033     
cpmsiz         =  16+    lsts           =f00f+    waitcr          e9b2     
cr             =  8d+    match           e911     wb_0            e72d+    
csts           =f009+    maxdsk         =   6+    wb_1            e72f     
csv0            ee91     movcurs        =f027+    wboot           e71d     
csv1            ef46     mres           =   1+    wboote          e603     
csv2            ed8c     msgcr           e9af     wbxlt           e7c9     
csv3            eda8     msize          =  3c+    wd_wb           e74b+    
csv4            edc2     ndevmsg         ea3f     wdbboot         1000     
csv5            edd4     nobuff          e96c     wdbbt1          1009     
curdsk         =   4+    norm           =  40+    wdbloc          1044+    
defbuf          ec00     nosysmsg        e9ba     wddsec         =  20+    
defldma        =  80+    notdev          e830     wddsiz         =   2+    
dfti.o         =  81+    pfx            =  93+    wddspt         =  40+    
dirbuf          ed00     phydsk          ea73     wdini          =f018+    
diskrd          e94d     physec          ea76     wdio           =f01b+    
diskwt          e950     preblk          ea82     wdrdwt          e95f+    
dpb0            e6cc     predma          ea7f     wrall          =   0+    
dpb01           e6db     predsk          ea7a     wrdir          =   1+    
dpb1            e6ea     prephy          ea7b     write           e882     
dpb12           e6f9     prer.w          ea81     wrtflg          ea83     
dpb2            e708     presec          ea7e     wrtpng          e941     
dpbase         =e633+    pretrk          ea7c     wrtype          ea84     
dpe0            e633+    printat        =f024+    wrual          =   2+    
dpe1            e643+    pun            =   0+    wtchk           e8fd     
dpe2            e653+    punch           e82a     xlt0           =   0+    
dpe3            e663+    r256.1          e8c8     xlt1            e693     
dpe4            e673+    r256.2          e8d1     xlt2            e6bb     
dpe5            e683+    r256.3          e8d8     
endmsg         =  24+    rdr            =   0+    
