   1:			;;
   2:			;;----------------------------------------------------------------------------
   3:			;; Z80DARKSTAR BOOTLOADER FOR FLOPPIES, HARD (IDE) AND VIRTUAL DISKS
   4:			;;----------------------------------------------------------------------------
   5:			;;
   6:				include	darkstar.equ
**** darkstar.equ ****
   1:			;****** Equ's file autogenerated by genequs ver: 1.0
   2:			;****** Input files:
   3:			;****** SysCommon.lst
   4:	FE77          	TX0            	EQU	0FE77H
   5:	FDC4          	FIN            	EQU	0FDC4H
   6:	FE79          	TX01           	EQU	0FE79H
   7:	FD89          	DLY1           	EQU	0FD89H
   8:	FD87          	DLY2           	EQU	0FD87H
   9:	FDE1          	FOUT           	EQU	0FDE1H
  10:	FE65          	U1NUL          	EQU	0FE65H
  11:	FE25          	U0ISR          	EQU	0FE25H
  12:	FE5B          	U1ISR          	EQU	0FE5BH
  13:	FD85          	DELAY          	EQU	0FD85H
  14:	FE50          	UISRE          	EQU	0FE50H
  15:	FDB5          	FSTAT          	EQU	0FDB5H
  16:	FE35          	UISRI          	EQU	0FE35H
  17:	FE6F          	DOSTX          	EQU	0FE6FH
  18:	FC4B          	BBU1ST         	EQU	0FC4BH
  19:	FC45          	BBU1RX         	EQU	0FC45H
  20:	FC3F          	BBU1TX         	EQU	0FC3FH
  21:	FD29          	BBEXEC         	EQU	0FD29H
  22:	FCFF          	BBHDRD         	EQU	0FCFFH
  23:	FD6A          	BBVOID         	EQU	0FD6AH
  24:	FE92          	UASTKB         	EQU	0FE92H
  25:	FD6B          	MMPMAP         	EQU	0FD6BH
  26:	FE0F          	INTRDI         	EQU	0FE0FH
  27:	FC2D          	SCONIN         	EQU	0FC2DH
  28:	FC15          	VCONIN         	EQU	0FC15H
  29:	FCDB          	BBDIV16        	EQU	0FCDBH
  30:	FCF9          	BBHDWR         	EQU	0FCF9H
  31:	FD78          	MMGETP         	EQU	0FD78H
  32:	FDFE          	INTREN         	EQU	0FDFEH
  33:	FE85          	RLDROM         	EQU	0FE85H
  34:	FCE1          	BBMUL16        	EQU	0FCE1H
  35:	FC00          	SYSCOM         	EQU	0FC00H
  36:	FE90          	UASTAV         	EQU	0FE90H
  37:	FE19          	SYTIMR         	EQU	0FE19H
  38:	FC33          	SCONST         	EQU	0FC33H
  39:	FC1B          	VCONST         	EQU	0FC1BH
  40:	FE6D          	SRXRSM         	EQU	0FE6DH
  41:	FE69          	SRXSTP         	EQU	0FE69H
  42:	FC39          	BBU0INI        	EQU	0FC39H
  43:	FC51          	BBU1INI        	EQU	0FC51H
  44:	FC87          	BBFREAD        	EQU	0FC87H
  45:	FD23          	BBEIDCK        	EQU	0FD23H
  46:	FD05          	BBHDGEO        	EQU	0FD05H
  47:	FEC0          	BBSTACK        	EQU	0FEC0H
  48:	FC81          	BBFHOME        	EQU	0FC81H
  49:	FD94          	BBCONIN        	EQU	0FD94H
  50:	FFF0          	SINTVEC        	EQU	0FFF0H
  51:	FEC0          	SYSCMLO        	EQU	0FEC0H
  52:	FE22          	VOIDISR        	EQU	0FE22H
  53:	FC9F          	BBSTTIM        	EQU	0FC9FH
  54:	FDAA          	BBCONST        	EQU	0FDAAH
  55:	FC27          	SCONOUT        	EQU	0FC27H
  56:	FC0F          	VCONOUT        	EQU	0FC0FH
  57:	FCE7          	BBOFFCAL       	EQU	0FCE7H
  58:	FC57          	BBINICTC       	EQU	0FC57H
  59:	FE9C          	BBSTBASE       	EQU	0FE9CH
  60:	FC5D          	BBRESCTC       	EQU	0FC5DH
  61:	FCA5          	BBRDTIME       	EQU	0FCA5H
  62:	FD5A          	BBCALRET       	EQU	0FD5AH
  63:	FCB7          	BBDMASET       	EQU	0FCB7H
  64:	FCBD          	BBDSKSEL       	EQU	0FCBDH
  65:	FCED          	BBHDINIT       	EQU	0FCEDH
  66:	FCB1          	BBSECSET       	EQU	0FCB1H
  67:	FD0B          	BBHDBOOT       	EQU	0FD0BH
  68:	FC69          	BBUPLCHR       	EQU	0FC69H
  69:	FC99          	BBPRNCHR       	EQU	0FC99H
  70:	FCC9          	BBVCPMBT       	EQU	0FCC9H
  71:	FC93          	BBFLOPIO       	EQU	0FC93H
  72:	FD1D          	BBEPMNGR       	EQU	0FD1DH
  73:	FCCF          	BBSIDSET       	EQU	0FCCFH
  74:	FD11          	BBLDPART       	EQU	0FD11H
  75:	FC75          	BBRDVDSK       	EQU	0FC75H
  76:	FC8D          	BBFWRITE       	EQU	0FC8DH
  77:	FCC3          	BBCPBOOT       	EQU	0FCC3H
  78:	FC21          	BBCURSET       	EQU	0FC21H
  79:	FCAB          	BBTRKSET       	EQU	0FCABH
  80:	FC7B          	BBWRVDSK       	EQU	0FC7BH
  81:	FD9F          	BBCONOUT       	EQU	0FD9FH
  82:	FCF3          	BBDRIVEID      	EQU	0FCF3H
  83:	FC63          	BBPSNDBLK      	EQU	0FC63H
  84:	FC03          	BBCRTCINI      	EQU	0FC03H
  85:	FC6F          	BBPRCVBLK      	EQU	0FC6FH
  86:	FC09          	BBCRTFILL      	EQU	0FC09H
  87:	FCD5          	BBFDRVSEL      	EQU	0FCD5H
  88:	FD17          	BBDPRMSET      	EQU	0FD17H
  89:			;****** EOF ***
  90:			
**** bootload.asm ****
   7:				include	syshw.inc
**** syshw.inc ****
   1:			;
   2:			;=======================================================================
   3:			;
   4:			; Modular Z80 DarkStar (NE Z80) SysBios
   5:			;
   6:			;=======================================================================
   7:			;
   8:			; Original code:
   9:			; Z80 Nuova Elettronica Monitor 390 su eprom 2532 (4k)
  10:			;
  11:			; Disassembled and reconstructed by
  12:			; Piergiorgio Betti <pbetti@lpconsul.net> on 2005 01 26
  13:			;
  14:			; Latest non modular BIOS is DARKSTAR-MONITOR-0.9.0.asm
  15:			; dated 20140531
  16:			; - Following addition of MultiF-Board doing complete rewrite of the
  17:			;   monitor/BIOS has been started.
  18:			;   Major goals:
  19:			;   o Modularization: Now monitor can grow up to 256kb instead of 4kb
  20:			;     :-)
  21:			;   o Specialized images fitted in memory page (4kb) or multiples
  22:			;   o Full support for new hardware
  23:			;   o I/O rewrite for MODE 2 interrupts
  24:			;   Minor goals:
  25:			;   o Full code clean-up & reoarganization
  26:			; ---------------------------------------------------------------------
  27:			; Revisions:
  28:			; 20140905 - Modified hexadecimal constants to 0xxH format to be widely
  29:			;            accepted by different assemblers
  30:			; 20150714 - Modified to implement serial XON/XOFF and RTS/CTS
  31:			; ---------------------------------------------------------------------
  32:			
  33:			; ---------------------------------------------------------------------
  34:			; SYSBIOS
  35:			;
  36:			; This is the BIOS non-resident portion of the new (banked)
  37:			; BIOS/Monitor for the NE Z80 (aka DarkStar)
  38:			;
  39:			; ---------------------------------------------------------------------
  40:			;
  41:			; Full BIOS memory scheme:
  42:			;
  43:			;	+-----------------+
  44:			;	+    SysCommon    +   <-- Resident portion. Common to all images
  45:			;	+   FC00 - FFFF   +
  46:			;	+-----------------+
  47:			;	+-----------------+   +-----------------+   +-----------------+
  48:			;	+     SysBios     +   +   BootMonitor   +   +     [Other]     +
  49:			;	+   F000 - FBFF   +   +   F000 - FBFF   +   +   F000 - FBFF   +
  50:			;	+-----------------+   +-----------------+   +-----------------+
  51:			;
  52:			;	         ^                     ^                     ^
  53:			;	         |                     |                     |
  54:			;	         ---------------------------------------------
  55:			;	                      Variable section
  56:			;
  57:			; The above are always assembled at ORG F000 and linked and allocated
  58:			; in the EEPROM in this way:
  59:			;
  60:			;	+-----------------+
  61:			;	+    SysCommon    +
  62:			;	+   FC00 - FFFF   +
  63:			;	+     SysBios     +     <-- EEPROM page 1 ($C1000)
  64:			;	+   F000 - FBFF   +
  65:			;	+-----------------+
  66:			;	+-----------------+
  67:			;	+    SysCommon    +
  68:			;	+   FC00 - FFFF   +
  69:			;	+   BootMonitor   +     <-- EEPROM page 0 ($C0000)
  70:			;	+   F000 - FBFF   +
  71:			;	+-----------------+
  72:			;
  73:			; ---------------------------------------------------------------------
  74:			;
  75:			; Define which assembler we are using
  76:			;
  77:			
  78:			; PASMO	EQU	1
  79:	0001          	MZMAC	EQU	1
  80:			; ZMAC	EQU	1			; ZMAC Z80 assembler, not Linux/Unix version
  81:			
  82:			; ... only one at a time can be active (1) ...
  83:			
  84:			;
  85:			; Monitor version numbers (major.minor)
  86:			;
  87:	0033          	MONMAJ		EQU	'3'
  88:	0034          	MONMIN		EQU	'4'
  89:			
  90:			;
  91:			; Buffers addresses labels
  92:			;
  93:			
  94:			; -- Global --
  95:	0003          	IOBYTE		EQU	0003H		; byte: Intel IOBYTE (CP/M 2.2 only)
  96:	0004          	CDISK		EQU	0004H		; byte: Last logged drive
  97:	0006          	BTPASIZ		EQU	0006H		; word: size of tpa + 1
  98:			;
  99:			; -- Private --
 100:	000B          	HMEMPAG		EQU	000BH		; byte: highest ram page
 101:	000C          	BBCBANK		EQU	000CH		; byte: current bank
 102:	000D          	BBCSTCK		EQU	000DH		; word: current stack
 103:					;
 104:	004F          	PRVTOP		EQU	004FH		; top of private area storage
 105:	004F          	COLBUF		EQU	PRVTOP		; byte:
 106:	004E          	DSELBF		EQU	COLBUF-1	; byte: floppy drive select status
 107:								; - bits: 0 = drive 0
 108:								; - bits: 1 = drive 1
 109:								; - bits: 2 = drive 2
 110:								; - bits: 3 = drive 3
 111:								; - bits: 4 = unused
 112:								; - bits: 5 = head select
 113:								; - bits: 6 = motor on (disabled by jumper)
 114:								; - bits: 7 = unused
 115:	004D          	KBDBYTE		EQU	DSELBF-1	; byte: store keyboard input
 116:	004C          	MIOBYTE		EQU	KBDBYTE-1	; byte:
 117:								; - bits: 0: 0 = floppy write		1 = floppy read
 118:								;         1: 0 = no ctrl on keypress	1 = ctrl on keypress
 119:								;         2: 0 = scroll			1 = no scroll
 120:								;         3: 0 = accept lowercase	1 = convert to uppercase
 121:								;         4: 0 = destr. bkspace		1 = non destr. bkspace
 122:								;         5: 0 = console out		1 = serial out
 123:								;         6: 0 = disp. all chars	1 = obscure non punct.
 124:								;         7: 0 = ctrl chr set 1		1 = ctrl chr set 2
 125:	004B          	TMPBYTE		EQU	MIOBYTE-1	; byte: transients flags
 126:								; - bits: 0: 0 = high in cursor addressing
 127:								;         1: 0 = ESC catched by ANSI driver
 128:								;         2: 0 = CSI catched by ANSI driver
 129:								;         3: 0 = Two byte code ESC seq. from serial
 130:								;         4: 0 = Plain serial i/o (disable ANSI driver)
 131:								;         5: 0 = store interrupt status (on/off)
 132:								;         6: 0 = floppy home on err	1 = no home on err
 133:								;         7: 0 = unlock LBA free addressing (unpartitioned)
 134:	004A          	CURSSHP		EQU	TMPBYTE-1	; cursor shape
 135:	0048          	CURPBUF		EQU	CURSSHP-2	; word: cursor position
 136:	0046          	FTRKBUF		EQU	CURPBUF-2	; word: track # for i/o (0 - 65535)
 137:	0045          	FDRVBUF		EQU	FTRKBUF-1	; byte: drive number for i/0 (0 - 15)
 138:	0043          	FSECBUF		EQU	FDRVBUF-2	; word: sector # for i/o (1 .. 65535)
 139:	0041          	FRDPBUF		EQU	FSECBUF-2	; word: dma address for i/o
 140:	003F          	FSEKBUF		EQU	FRDPBUF-2	; word: current track number for drive A/B
 141:	003E          	RAM3BUF		EQU	FSEKBUF-1	; byte:
 142:	003D          	RAM2BUF		EQU	RAM3BUF-1	; byte:
 143:	003C          	RAM1BUF		EQU	RAM2BUF-1	; byte:
 144:	003B          	RAM0BUF		EQU	RAM1BUF-1	; byte:
 145:	003A          	RST7SP3		EQU	003AH		; keep clear area of RST38 (RST7)
 146:	0039          	RST7SP2		EQU	0039H
 147:	0038          	RST7SP1		EQU	0038H
 148:	002F          	RSRVBUF		EQU	RST7SP1-9	; free 9 byte buffer
 149:	002D          	APPBUF		EQU	RSRVBUF-2	; word: generic buffer
 150:	002C          	COPSYS		EQU	APPBUF-1	; Op system type for partition selection
 151:	002B          	UART0BR		EQU	COPSYS-1	; UART 0 baudrate
 152:	002A          	UART1BR		EQU	UART0BR-1	; UART 1 baudrate
 153:	0029          	CTC0TC		EQU	UART1BR-1	; CTC channel 0 time constant
 154:	0028          	CTC1TC		EQU	CTC0TC-1	; CTC channel 1 time constant
 155:	0027          	TIMRCON		EQU	CTC1TC-1	; timer buf
 156:	0026          	CNFBYTE		EQU	TIMRCON-1	; config byte
 157:								; - bits: 0: 0 = UART1 intr disabled	1 = RST8 redir UART1
 158:								;         1: 1 = XON/XOFF enabled on UART0
 159:								;         2: 1 = RTS/CTS enabled on UART0
 160:								;         3: 0 = unused/reserved
 161:								;         4: 0 = unused/reserved
 162:								;         5: 0 = unused/reserved
 163:								;         6: 0 = unused/reserved
 164:								;         7: 0 = unused/reserved
 165:	000F          	FIFOSTO		EQU	000FH		; fifo queues storage start
 166:	0008          	FIFSIZE		EQU	8		; fifo queue lenght
 167:	000B          	FIFBLOK		EQU	11		; fifo queue size
 168:	000F          	FIFOU0		EQU	FIFOSTO		; uart 0 queue (alternate console)
 169:	001A          	FIFOKB		EQU	FIFOU0+FIFBLOK	; keyboard queue
 170:	0025          	FIFOEND		EQU	FIFOKB+FIFBLOK	; fifo blocks end
 171:			;
 172:	3000          	BLDOFFS		EQU	3000H		; place for disk bootloader
 173:			
 174:			;
 175:			; Some commodity equs
 176:			;
 177:	000D          	CR		EQU	0DH		; ascii CR & LF
 178:	000A          	LF		EQU	0AH
 179:	000C          	FF		EQU	0CH		; FORM FEED (clear screen)
 180:	001B          	ESC		EQU	1BH		; ESCape
 181:	0011          	XONC		EQU	11H		; Xon
 182:	0013          	XOFC		EQU	13H		; Xoff
 183:	FFFF          	TRUE		EQU	-1
 184:	0000          	FALSE		EQU	0
 185:	0100          	TPA		EQU	0100H		; TPA base address (for CP/M)
 186:			
 187:			;
 188:			; Modules equs
 189:			;
 190:				; delay
 191:	00F6          	MSCNT		EQU	246
 192:				; mmu
 193:	000D          	MMUTSTPAGE	EQU	0DH		; logical page used for sizing
 194:	D000          	MMUTSTADDR	EQU	MMUTSTPAGE<<12	; logical page used for sizing
 195:			
 196:			; Conventionally all bios/monitor images start at $F000.
 197:			; Except for special cases all code is copied to ram @ $F000.
 198:			; In this case eeprom page 0 is directly mapped into logical space
 199:			; by hardware so we can initialize the system at cold boot.
 200:			;
 201:			; We assume to initialize MMU as follow:
 202:			;
 203:			; +--------+
 204:			; |  F000  |	-> $C0000  eeprom page 0
 205:			; +--------+
 206:			; +--------+
 207:			; |  EFFF  |
 208:			; +--------+
 209:			;     ...       -> $00000 to $0EFFF ram
 210:			; +--------+
 211:			; |  0000  |
 212:			; +--------+
 213:			;
 214:			
 215:			
 216:			; include	modules/hwequs.inc.asm
 217:			; Hardware equates
 218:			; ---------------------------------------------------------------------
 219:			
 220:			; ---------------------------------------------------------------------
 221:			; LX529 VIDEO BOARD:
 222:			; ---------------------------------------------------------------------
 223:	0080          	CRTBASE		EQU	80H
 224:				; RAM0 for ascii chars & semi6. Combined with RAM1 and RAM2 for graphics
 225:	0080          	CRTRAM0DAT	EQU	CRTBASE		; RAM0 access: PIO0 port A data register
 226:	0082          	CRTRAM0CNT	EQU	CRTBASE+2	; RAM0 access: PIO0 port A control register
 227:				; Printer port
 228:	0081          	CRTPRNTDAT	EQU	CRTBASE+1	; PRINTER (output): PIO0 port B data register
 229:	0083          	CRTPRNTCNT	EQU	CRTBASE+3	; PRINTER (output): PIO0 port B control register
 230:								; STROBE is generated by hardware
 231:				; RAM1 for graphics. (pixel index by RAM0+RAM1+RAM2)
 232:	0084          	CRTRAM1DAT	EQU	CRTBASE+4	; RAM1 access: PIO1 port A data register
 233:	0086          	CRTRAM1CNT	EQU	CRTBASE+6	; RAM1 access: PIO1 port A control register
 234:				; Keyboard port (negated). Bit 7 is for strobe
 235:	0085          	CRTKEYBDAT	EQU	CRTBASE+5	; KEYBOARD (input): PIO1 port B data register
 236:	0087          	CRTKEYBCNT	EQU	CRTBASE+7	; KEYBOARD (input): PIO1 port B control register
 237:	0007          	KEYBSTRBBIT	EQU	7		; Strobe bit
 238:				; RAM2 for graphics. (pixel index by RAM0+RAM1+RAM2)
 239:	0088          	CRTRAM2DAT	EQU	CRTBASE+8	; RAM2 access: PIO2 port A data register
 240:	008A          	CRTRAM2CNT	EQU	CRTBASE+10	; RAM2 access: PIO2 port A control register
 241:				; Service/User port
 242:	0089          	CRTSERVDAT	EQU	CRTBASE+9	; Service (i/o): PIO2 port B data register
 243:	008B          	CRTSERVCNT	EQU	CRTBASE+11	; Service (i/o): PIO2 port B control register
 244:	0000          	PRNTBUSYBIT	EQU	0		; Printer BUSY bit		(in)	1
 245:	0001          	CRTWIDTHBIT	EQU	1		; Set 40/80 chars per line	(out)	0
 246:	0002          	PIO2BIT2	EQU	2		; user 1 (input)		(in)	1
 247:	0003          	PIO2BIT3	EQU	3		; user 2 (input)		(in)	1
 248:	0004          	PIO2BIT4	EQU	4		; user 3 (input)		(in)	1
 249:	0005          	CLKSCLK		EQU	5		; DS1320 clock line		(out)	0
 250:	0006          	CLKIO		EQU	6		; DS1320 I/O line		(i/o)	1
 251:	0007          	CLKRST		EQU	7		; DS1320 RST line		(out)	0
 252:				; normal set for PIO2 (msb) 01011101 (lsb) that is hex $5D
 253:								; Other bits available to user
 254:				; RAM3 control chars/graphics attributes
 255:	008E          	CRTRAM3PORT	EQU	CRTBASE+14	; RAM3 port
 256:	0000          	CRTBLINKBIT	EQU	0		; Blink
 257:	0001          	CRTREVRSBIT	EQU	1		; Reverse
 258:	0002          	CRTUNDERBIT	EQU	2		; Underline
 259:	0003          	CRTHILITBIT	EQU	3		; Highlight
 260:	0004          	CRTMODEBIT	EQU	4		; ASCII/GRAPHIC mode
 261:				; Beeper port
 262:	008F          	CRTBEEPPORT	EQU	CRTBASE+15	; Beeper port
 263:				; 6545 CRT controller ports
 264:	008C          	CRT6545ADST	EQU	CRTBASE+12	; Address & Status register
 265:	008D          	CRT6545DATA	EQU	CRTBASE+13	; Data register
 266:				; Cursor modes
 267:	0040          	BLISLOWBLOK	EQU	40H		; Blink, slow, block
 268:	004A          	BLISLOWLINE	EQU	4AH		; Blink, slow, line
 269:	0060          	BLIFASTBLOK	EQU	60H		; Blink, fast, block
 270:	006A          	BLIFASTLINE	EQU	6AH		; Blink, fast, line
 271:	0020          	CURSOROFF	EQU	20H		; Off
 272:	0000          	FIXBLOCK	EQU	00H		; Fixed, block
 273:	000A          	CURSORON	EQU	0AH		; On
 274:			
 275:			; ---------------------------------------------------------------------
 276:			; LX390 FDC CONTROLLER:
 277:			; ---------------------------------------------------------------------
 278:	00D0          	FDCBASE		EQU	0D0H
 279:	00D0          	FDCCMDSTATR	EQU	FDCBASE		; Command and status register
 280:	00D1          	FDCTRAKREG	EQU	FDCBASE+1	; Track register
 281:	00D2          	FDCSECTREG	EQU	FDCBASE+2	; Sector register
 282:	00D7          	FDCDATAREG	EQU	FDCBASE+7	; Data register *** Verificare che sia $d7
 283:	00D6          	FDCDRVRCNT	EQU	FDCBASE+6	; Driver select/control register
 284:			;
 285:	0007          	FDCRESTC	EQU	00000111b	; 1771 restore (seek to trak 0) cmd
 286:	0017          	FDCSEEKC	EQU	00010111b	; seek cmd
 287:	0088          	FDCREADC	EQU	10001000b	; read cmd
 288:	00A8          	FDCWRITC	EQU	10101000b	; write cmd
 289:	00D0          	FDCRESET	EQU	11010000b	; fdc reset immediate cmd
 290:			;
 291:			; ---------------------------------------------------------------------
 292:			; LX389: PARALLEL INTERFACE
 293:			; ---------------------------------------------------------------------
 294:			; alternate printer port
 295:	0003          	ALTPRNPRT	EQU	03H
 296:			;
 297:			; parallel port PC link
 298:	0003          	PPDATAP		EQU	03H		; Data port
 299:	0002          	PPCNTRP		EQU	02H		; Control port
 300:	0000          	PPSTROB		EQU	0		; Strobe bit
 301:	0001          	PPAKSTB		EQU	1		; Acknowledge/Stop bit
 302:			;
 303:	0000          	PPDINI		EQU	00H		; 00000000 Dnl Init byte
 304:	0004          	PPDRDY		EQU	04H		; 00000100 Dnl Ready
 305:	0006          	PPDSTP		EQU	06H		; 00000110 Dnl Stop
 306:	0002          	PPDOKG		EQU	02H		; 00000010 Dnl Ok Go
 307:	0001          	PPUINI		EQU	01H		; 00000001 Upl Init byte
 308:	0005          	PPURDY		EQU	05H		; 00000101 Upl Ready
 309:	0007          	PPUACK		EQU	07H		; 00000111 Upl Acknowledge
 310:	0003          	PPUOKG		EQU	03H		; 00000011 Upl Ok Go
 311:			;
 312:			; virtual disks (PC-linked over parallel port)
 313:	0000          	VDRDSEC		EQU	0		; read sector command
 314:	0001          	VDWRSEC		EQU	1		; write sector command
 315:	000A          	VDBUFSZ		EQU	10		; 10 bytes block
 316:			; ---------------------------------------------------------------------
 317:			; MULTF-BOARD: MMU, IDE, SERIAL, CTC
 318:			; ---------------------------------------------------------------------
 319:			; -- I/O --
 320:	0020          	MMUPORT		EQU	20H
 321:	0021          	MENAPRT		EQU	21H
 322:			; -- Map --
 323:	00C0          	EEPAGE0		EQU	0C0H		; page 0 of eeprom
 324:	F000          	EEPSTA		EQU	0F000H		; eeprom location after MMU reset
 325:	00EF          	MMTPAPAG	EQU	(EEPSTA>>8)-1	; TPA top page (256 bytes pages)
 326:	00FF          	IMTPAG		EQU	0FFH		; eeprom page with image table
 327:	0400          	IMTSIZ		EQU	1024		; size
 328:	E000          	RAMTBL		EQU	0E000H		; ram table location
 329:	0030          	TBLBLK		EQU	48		; block size
 330:	0014          	MAXBLK		EQU	20		; max images
 331:	03C0          	RTBSIZ		EQU	TBLBLK * MAXBLK	; real table size
 332:								; A table block is:
 333:	0008          	TNAMELEN	EQU	8		;	name		: 8 bytes
 334:	0002          	TPAGELEN	EQU	2		;	page offset	: 2 bytes
 335:	0004          	TIADDRLEN	EQU	4		;	image address	: 4 bytes
 336:	0004          	TSIZELEN	EQU	4		;	image size	: 4 bytes
 337:	0014          	TDESCLEN	EQU	20		;	description	: 20 bytes
 338:			; -- IDE --
 339:	00E0          	IDEPORTA	EQU	0E0H		; lower 8 bits of IDE interface
 340:	00E1          	IDEPORTB	EQU	0E1H		; upper 8 bits of IDE interface
 341:	00E2          	IDEPORTC	EQU	0E2H		; control lines for IDE interface
 342:	00E3          	IDEPORTCTRL	EQU	0E3H		; 8255 configuration port
 343:			
 344:	0092          	READCFG8255	EQU	10010010b	; Set 8255 IDEportC to output, IDEportA/B input
 345:	0080          	WRITECFG8255	EQU	10000000b	; Set all three 8255 ports to output mode
 346:			;IDE control lines for use with IDEportC.
 347:	0001          	IDEA0LINE	EQU	01H		; direct from 8255 to IDE interface
 348:	0002          	IDEA1LINE	EQU	02H		; direct from 8255 to IDE interface
 349:	0004          	IDEA2LINE	EQU	04H		; direct from 8255 to IDE interface
 350:	0008          	IDECS0LINE	EQU	08H		; inverter between 8255 and IDE interface
 351:	0010          	IDECS1LINE	EQU	10H		; inverter between 8255 and IDE interface
 352:	0020          	IDEWRLINE	EQU	20H		; inverter between 8255 and IDE interface
 353:	0040          	IDERDLINE	EQU	40H		; inverter between 8255 and IDE interface
 354:	0080          	IDERSTLINE	EQU	80H		; inverter between 8255 and IDE interface
 355:			;Symbolic constants for the IDE Drive registers
 356:	0008          	REGDATA		EQU	IDECS0LINE
 357:	0009          	REGERR		EQU	IDECS0LINE + IDEA0LINE
 358:	000A          	REGSECCNT	EQU	IDECS0LINE + IDEA1LINE
 359:	000B          	REGSECTOR	EQU	IDECS0LINE + IDEA1LINE + IDEA0LINE
 360:	000C          	REGCYLLSB	EQU	IDECS0LINE + IDEA2LINE
 361:	000D          	REGCYLMSB	EQU	IDECS0LINE + IDEA2LINE + IDEA0LINE
 362:	000E          	REGSHD		EQU	IDECS0LINE + IDEA2LINE + IDEA1LINE		;(0EH)
 363:	000F          	REGCOMMAND	EQU	IDECS0LINE + IDEA2LINE + IDEA1LINE + IDEA0LINE	;(0FH)
 364:	000F          	REGSTATUS	EQU	IDECS0LINE + IDEA2LINE + IDEA1LINE + IDEA0LINE
 365:	0016          	REGCONTROL	EQU	IDECS1LINE + IDEA2LINE + IDEA1LINE
 366:	0016          	REGASTATUS	EQU	IDECS1LINE + IDEA2LINE + IDEA1LINE
 367:			;IDE Command Constants.
 368:	0010          	CMDRECAL	EQU	010H
 369:	0020          	CMDREAD		EQU	020H
 370:	0030          	CMDWRITE	EQU	030H
 371:	0091          	CMDINIT		EQU	091H
 372:	00EC          	CMDID		EQU	0ECH
 373:	00E0          	CMDSPINDOWN	EQU	0E0H
 374:	00E1          	CMDSPINUP	EQU	0E1H
 375:			; -- 16C550 UARTS --
 376:	00C0          	UART0BASE	EQU	0C0H		; Port base address for 0
 377:	00C8          	UART1BASE	EQU	0C8H		; Port base address for 1
 378:	00C0          	UART0		EQU	UART0BASE	; Select UART 0
 379:	00C8          	UART1		EQU	UART1BASE	; Select UART 1
 380:	0000          	R0RXTX		EQU	0		; (r/w) RXD/TXD Transmit/Receive Buffer
 381:	0000          	R0BRDL		EQU	0		; (r/w) DLL  if bit 7 of LCR is set: Baud Rate Divisor LSB
 382:	0001          	R1IER		EQU	1		; (r/w) IER - Interrupt Enable Register
 383:	0001          	R1BRDM		EQU	1		; (r/w) DLM if bit 7 of LCR is set: Baud Rate Divisor MSB
 384:	0002          	R2IIR		EQU	2		; (r)   IIR - Interrupt Identification Register
 385:	0002          	R2FCR		EQU	2		; (w)   FCR - FIFO Control Register
 386:	0003          	R3LCR		EQU	3		; (r/w) LCR - Line Control Register
 387:	0004          	R4MCR		EQU	4		; (r/w) MCR - Modem Control Register
 388:	0005          	R5LSR		EQU	5		; (r)   LSR - Line Status Register
 389:	0006          	R6MSR		EQU	6		; (r)   MSR - Modem Status Register
 390:	0007          	R7SPR		EQU	7		; (r/w) SPR - Scratch Pad Register
 391:				; speeds:
 392:	0060          	UART1200	EQU	96		; = 1,843,200 / ( 16 x 1200 )
 393:	0030          	UART2400	EQU	48		; = 1,843,200 / ( 16 x 2400 )
 394:	0018          	UART4800	EQU	24		; = 1,843,200 / ( 16 x 4800 )
 395:	000C          	UART9600	EQU	12		; = 1,843,200 / ( 16 x 9600 )
 396:	0006          	UART19K2	EQU	06		; = 1,843,200 / ( 16 x 19,200 )
 397:	0003          	UART38K4	EQU	03		; = 1,843,200 / ( 16 x 38,400 )
 398:	0002          	UART57K6	EQU	02		; = 1,843,200 / ( 16 x 57,600 )
 399:	0001          	UART115K2	EQU	01		; = 1,843,200 / ( 16 x 115,200 )
 400:			
 401:	0006          	U0DEFSPEED	EQU	UART19K2	; UART 0 default speed
 402:	000C          	U1DEFSPEED	EQU	UART9600	; UART 1 default speed
 403:			; -- Z80CTC --
 404:	00E8          	CTCBASE		EQU	0E8H
 405:	00E8          	CTCCHAN0	EQU	CTCBASE+0	; Channel 1 - Free
 406:	00E9          	CTCCHAN1	EQU	CTCBASE+1	; Channel 2 - System Timer
 407:	00EA          	CTCCHAN2	EQU	CTCBASE+2	; Channel 3 - UART 1 Interrupt
 408:	00EB          	CTCCHAN3	EQU	CTCBASE+3	; Channel 4 - UART 0 Interrupt
 409:	0020          	CTC0TCHI	EQU	32		; hi speed chan. 0 tc: 4Mhz / 256 / 32 = 488.28 Hz
 410:	0005          	CTC1TC100HZ	EQU	5		; lo speed chan. 1 tc: 488.28 Hz / 5 = ~ 97.6 Hz
 411:	000A          	CTC1TC50HZ	EQU	10		; lo speed chan. 1 tc: 488.28 Hz / 10 = ~ 48.8 Hz
 412:	0013          	CTC1TC25HZ	EQU	19		; lo speed chan. 1 tc: 488.28 Hz / 19 = ~ 25 Hz
 413:	0030          	CTC1TC10HZ	EQU	48		; lo speed chan. 1 tc: 488.28 Hz / 48 = ~ 10 Hz
 414:	00F4          	CTC1TC2HZ	EQU	244		; lo speed chan. 1 tc: 488.28 Hz / 244 = ~ 2 Hz
 415:	0013          	SYSHERTZ	EQU	CTC1TC25HZ	; System timer hertz
 416:			; -- EEPROM --
 417:	0001          	EEP29EE		EQU	01H		; type 29EE020
 418:	0002          	EEP29XE		EQU	02H		; type 29LE020 or 29VE020
 419:	0004          	EEP29C		EQU	04H		; type 29C020
 420:	0008          	EEPUNSUPP	EQU	08H		; unsupported
 421:	0010          	EEPROGLOCK	EQU	10H		; programming locked
 422:				;
 423:	0080          	EERINEPROM	EQU	80H		; tried to program eeprom running inside it
 424:			
 425:			;
 426:			; MMU organization
 427:			;
 428:			; MMU manage 16 4kb pages in Z80 address space (logical)
 429:			; It can assign any of 256 4k pages (physical) from its
 430:			; 1Mb address space.
 431:			;
 432:			; To load phisycal page XXh to logical page (in CPU address space) Y,
 433:			; you should consider that MMU is at a fixed address 20h and that
 434:			; logical 4K page Y is derived in the MMU by the usage of A12,A13,A14
 435:			; and A15 address lines during an I/O instruction.
 436:			;
 437:			; So to address phys. ram page 00h at the top of logical space page Fh
 438:			; you need to have Fh * on top address lines * because this address
 439:			; is the index to MMU page.
 440:			;
 441:			; So:
 442:			;
 443:			; 	LD	A,00h		<--- phis. page number	00xxxh (4k page)
 444:			; 	LD	B,F0h		<--- log. page number 	 Fxxxh (cpu page)
 445:			; 	LD	C,20h		<--- MMU I/O address
 446:			; 	OUT	(C),A
 447:			; 	RET
 448:			;
 449:			; The OUT instruction place:
 450:			; A on data lines D0-D7
 451:			; Fh (from B register) on A12-A15
 452:			; on port 20h (C register)
 453:			;
 454:			;
 455:			; Memory is organized as follow:
 456:			;
 457:			;	Slot 1	-> RAM	  -> 512k from 00000h to 7ffffh (mandatory)
 458:			;	Slot 2	-> RAM	  -> 128k from 80000h to 9ffffh (option 1)
 459:			;	Slot 2	-> RAM    -> 256k from 80000h to bffffh (option 2)
 460:			;	Slot 3	-> EEPROM -> 256k from c0000h to fffffh (mandatory)
 461:			;
 462:			
 463:			
 464:			;-------------------------------------
 465:			; Production / Testing
 466:			
 467:	FFFF          	BBDEBUG	EQU	TRUE
 468:			
 469:			
 470:			;-------------------------------------
 471:			; Segments, pages locations
 472:			
 473:	FFFF          	IF	BBDEBUG
 474:			
 475:	0004          	BBIMGP	EQU	04H		; Image location (DEBUG)
 476:	000E          	BBAPPP	EQU	0EH
 477:	000F          	BBPAG	EQU	0FH		; Base page location
 478:			
 479:			ELSE
 485:			ENDIF
 486:			
 487:	000D          	TRNPAG	EQU	0DH		; Page used for transient MMU ops
 488:	F000          	BBBASE	EQU	BBPAG << 12	; non resident base address
 489:	FC00          	BBCOMN	EQU	BBBASE + 0C00H	; resident portion address
 490:			
 491:	F000          	SYSBASE EQU	BBBASE		; use this to have 60K TPA
 492:			; SYSBASE EQU	BBCOMN		; use this to have 63K TPA
 493:			
 494:			;-------------------------------------
**** bootload.asm ****
   8:			
   9:			ISHD?	macro
  10:				xor	a
  11:				push	hl
  12:				ld	hl,ISHDB
  13:				cp	(hl)
  14:				pop	hl
  15:				endm
  16:			
  17:			ISVHD?	macro
  18:				xor	a
  19:				push	hl
  20:				ld	hl,ISVHD
  21:				cp	(hl)
  22:				pop	hl
  23:				endm
  24:			
  25:			;--------------------
  26:			
  27:				;; We CAN'T no more support 128 byte sector format...
  28:	0200          	SREFSIZ	EQU	512			; sector reference size
  29:	2000          	SIZE	EQU	8192			; more then the size of CPMLDR
  30:			
  31:	3000          		ORG 	BLDOFFS			; code start
  32:			
  33:	3000  55AA    		DEFB	$55,$AA			; loader signature
  34:			
  35:			;       CP/M 3 boot-loader for Z80Darkstar (NEZ80)
  36:			;
  37:			;       Copyrigth (C) 2005-2014 by Piergiorgio Betti
  38:			;
  39:				;
  40:				;       begin the load operation
  41:				;
  42:			
  43:	3002          	BOOTLOAD:
  44:	3002  06F0    		LD	B,BBPAG << 4		; very important:
  45:	3004  0E20    		LD	C,MMUPORT		; ensure that sysbios boot page ($BB)
  46:	3006  3A0B00  		LD	A,(HMEMPAG)		; is effectively selected, since sysbios
  47:	3009  D604    		SUB	4			; boot code not always return to base (boot)
  48:	300B  ED79    		OUT	(C),A			; page...
  49:				;
  50:	300D  318000  		LD      SP,$80			; use space below buffer for stack
  51:	3010  3A0400  		LD	A,(CDISK)		; select...
  52:	3013  4F      		LD	C, A			; logged drive
  53:	3014  CDBDFC  		CALL	BBDSKSEL		;
  54:	3017  DD215131		LD	IX,FLSECS		; default floppy
  55:	301B  FE02    		CP	2			; is floppy ?
  56:	301D  FA3F30  		JP	M,BLINI			; yes
  57:	3020  FE0E    		CP	14			; is IDE ?
  58:	3022  FA3630  		JP	M,HDINI			; yes
  59:	3025  FE0F    		CP	15			; virtual hd ?
  60:	3027  2802    		JR	Z,VHD			; yes (P:)
  61:	3029  1814    		JR	BLINI			; no, virtual floppy (O:)
  62:			
  63:			
  64:	302B          	VHD:
  65:	302B  DD215531		LD	IX,HDSECS		; hd params
  66:	302F  AF      		XOR	A			; will use as a flag for hd operations
  67:	3030  3D      		DEC	A
  68:	3031  325A31  		LD	(ISVHD),A
  69:	3034  1809    		JR	BLINI
  70:			
  71:	3036          	HDINI:
  72:	3036  DD215531		LD	IX,HDSECS		; hd params
  73:	303A  AF      		XOR	A			; will use as a flag for hd operations
  74:	303B  3D      		DEC	A
  75:	303C  325931  		LD	(ISHDB),A
  76:				;
  77:				;	drive logged, calc sectors to read
  78:				;
  79:	303F  DD6E00  	BLINI:	LD	L,(IX+0)		; sec. per track in HL
  80:	3042  DD6601  		LD	H,(IX+1)
  81:	3045  DD5E02  		LD	E,(IX+2)		; sec. size in DE
  82:	3048  DD5603  		LD	D,(IX+3)
  83:	304B  CD17FD  		CALL	BBDPRMSET		; setup in sysbios
  84:	304E  DDE5    		PUSH	IX
  85:	3050  010020  		LD	BC,SIZE			; CP/M size in BC
  86:	3053  CDDBFC  		CALL	BBDIV16			; div cpmsize/secsize
  87:	3056  51      		LD	D,C			; # SECTORS in D
  88:	3057  14      		INC	D			; pad
  89:				;
  90:				; track, side, start sector
  91:				;
  92:	3058  010000  		LD	BC, 0			; START TRACK
  93:	305B  CDABFC  		CALL	BBTRKSET
  94:	305E  CDCFFC  		CALL	BBSIDSET		; side 0 select
  95:	3061  FD210001		LD	IY,TPA			; IY = base offset
  96:	3065  1E01    		LD      E,1			; START SECTOR
  97:	3067          		ISHD?
  97:	3067  AF      		xor	a
  97:	3068  E5      		push	hl
  97:	3069  215931  		ld	hl,ishdb
  97:	306C  BE      		cp	(hl)
  97:	306D  E1      		pop	hl
  97:	306E          		endm
  97:			
  98:	306E  200C    		JR	NZ,HDSECT		; yes
  99:	3070          		ISVHD?
  99:	3070  AF      		xor	a
  99:	3071  E5      		push	hl
  99:	3072  215A31  		ld	hl,isvhd
  99:	3075  BE      		cp	(hl)
  99:	3076  E1      		pop	hl
  99:	3077          		endm
  99:			
 100:	3077  2002    		JR	NZ,INIVH		; yes
 101:	3079  180E    		JR	BLSECT
 102:			
 103:	307B          	INIVH:
 104:	307B  1C      		INC	E			; offset 1 for virtual
 105:				;
 106:				;       load the next sector
 107:				;
 108:	307C          	HDSECT:
 109:	307C  0600    		LD	B,0
 110:	307E  4B      		LD	C,E
 111:	307F  ED434300		LD	(FSECBUF),BC		; sector
 112:	3083  FD224100		LD	(FRDPBUF),IY		; dma
 113:	3087  1807    		JR	DORD
 114:			
 115:	3089  CD2D31  	BLSECT:	CALL	LSECTRA			; calc trans sector
 116:	308C  FD224100		LD	(FRDPBUF),IY		; next dma
 117:			
 118:				; since we are using a banked sysbios, to access the space
 119:				; freed from F000 to FC00 we must ensure CP/M load operation
 120:				; do NOT overwrite that space during bank switching operated by the
 121:				; BIOS, to serve our requests...
 122:	3090  2A4100  	DORD:	LD	HL,(FRDPBUF)		; load DMA address in HL
 123:	3093  E5      		PUSH	HL			; save it
 124:	3094  215B31  		LD	HL,BMBELOW		; temporary DMA after us
 125:	3097  224100  		LD	(FRDPBUF),HL		; set up
 126:	309A          		ISHD?
 126:	309A  AF      		xor	a
 126:	309B  E5      		push	hl
 126:	309C  215931  		ld	hl,ishdb
 126:	309F  BE      		cp	(hl)
 126:	30A0  E1      		pop	hl
 126:	30A1          		endm
 126:			
 127:	30A1  201E    		JR	NZ,RDIDE		; read HD sector
 128:	30A3          		ISVHD?
 128:	30A3  AF      		xor	a
 128:	30A4  E5      		push	hl
 128:	30A5  215A31  		ld	hl,isvhd
 128:	30A8  BE      		cp	(hl)
 128:	30A9  E1      		pop	hl
 128:	30AA          		endm
 128:			
 129:	30AA  2010    		JR	NZ,BRDVRT		; read virtual HD sector
 130:				; ------------------------------------------------
 131:	30AC  3A4500  		LD	A,(FDRVBUF)		; get active drive
 132:	30AF  FE02    		CP	2			; is real floppy ?
 133:	30B1  F2BC30  		JP	P,BRDVRT		; no
 134:	30B4  CDD5FC  	BRDFLO:	CALL	BBFDRVSEL		; activate driver
 135:	30B7  CD87FC  		CALL	BBFREAD			; do read
 136:	30BA  180E    		JR	CKERR
 137:	30BC  CD75FC  	BRDVRT:	CALL	BBRDVDSK		; call par. read
 138:	30BF  1809    		JR	CKERR
 139:	30C1  D5      	RDIDE:	PUSH	DE
 140:	30C2  FDE5    		PUSH	IY			; save ptrs
 141:	30C4  CDFFFC  		CALL	BBHDRD			; call ide read
 142:	30C7  FDE1    		POP	IY
 143:	30C9  D1      		POP	DE
 144:	30CA  B7      	CKERR:	OR	A
 145:	30CB  2040    		JR	NZ, BOOTNOK
 146:			
 147:	30CD  E1      		POP	HL			; recover real DMA address
 148:	30CE  D5      		PUSH	DE			; saves DE
 149:	30CF  EB      		EX	DE,HL			; DMA in DE
 150:	30D0  215B31  		LD	HL,BMBELOW		; our buffer
 151:	30D3  010002  		LD	BC,SREFSIZ		; size
 152:	30D6  EDB0    		LDIR				; put in right place
 153:	30D8  D1      		POP	DE			; recover our counters
 154:			
 155:				; go to next sector if load is incomplete
 156:	30D9  15      	SKIPRD:	DEC     D               	; sects=sects-1
 157:	30DA  CA0001  		JP      Z,TPA			; head for the cpmldr
 158:				;
 159:				;       more sectors to load
 160:				;
 161:	30DD  1C      	BLNXTS:	INC     E			; sector = sector + 1
 162:	30DE          		ISHD?
 162:	30DE  AF      		xor	a
 162:	30DF  E5      		push	hl
 162:	30E0  215931  		ld	hl,ishdb
 162:	30E3  BE      		cp	(hl)
 162:	30E4  E1      		pop	hl
 162:	30E5          		endm
 162:			
 163:	30E5  203E    		JR	NZ,HDDMA		; we do not check for end of track since
 164:	30E7          		ISVHD?				; for lba hd this is quit impossible
 164:	30E7  AF      		xor	a
 164:	30E8  E5      		push	hl
 164:	30E9  215A31  		ld	hl,isvhd
 164:	30EC  BE      		cp	(hl)
 164:	30ED  E1      		pop	hl
 164:	30EE          		endm
 164:			
 165:	30EE  2035    		JR	NZ,HDDMA		; (128kb tracks.......)
 166:	30F0  010002  		LD	BC,512			; bump dma address
 167:	30F3  FD09    		ADD	IY,BC
 168:	30F5  7B      		LD      A,E
 169:	30F6  DDE1    		POP	IX			; recover table address
 170:	30F8  DDE5    		PUSH	IX
 171:	30FA  DDBE00  		CP      (IX+0)			; last sector of track ?
 172:	30FD  208A    		JR      NZ,BLSECT		; no, go read another
 173:				;
 174:				;       end of track, increment to next track
 175:				;
 176:	30FF  ED4B4600		LD	BC, (FTRKBUF)		; track = track + 1
 177:	3103  03      		INC	BC
 178:	3104  ED434600		LD	(FTRKBUF),BC
 179:	3108  1E00    		LD      E,0			; sector = 0
 180:	310A  C38930  		JP      BLSECT			; for another track
 181:	310D          	BOOTNOK:
 182:	310D  214A31  		LD	HL, BLFAILM
 183:	3110  CD1931  		CALL	PRSTR
 184:				;
 185:	3113  CD94FD  		CALL	BBCONIN
 186:	3116  C300FC  	 	JP	$FC00			; Return to monitor boot menu
 187:	3119          	PRSTR:
 188:	3119  4E      		LD	C,(HL)
 189:	311A  79      		LD	A,C
 190:	311B  CBB9    		RES	7,C
 191:	311D  CD9FFD  		CALL	BBCONOUT
 192:	3120  23      		INC	HL
 193:	3121  07      		RLCA
 194:	3122  30F5    		JR	NC,PRSTR
 195:	3124  C9      		RET
 196:	3125          	HDDMA:
 197:	3125  010002  		LD	BC,512			; bump dma address
 198:	3128  FD09    		ADD	IY,BC
 199:	312A  C37C30  		JP	HDSECT
 200:			
 201:				;
 202:				; APPLY SKEW FACTOR
 203:				;
 204:	312D          	LSECTRA:
 205:	312D  E5      		PUSH	HL
 206:	312E  C5      		PUSH	BC
 207:	312F  0600    		LD	B,0
 208:	3131  4B      		LD	C,E			; current sec.
 209:	3132  213F31  		LD	HL,TRANS		; HL= trans
 210:	3135  09      		ADD     HL,BC			; HL= trans(sector)
 211:	3136  6E      		LD      L,(HL)			; L = trans(sector)
 212:	3137  2600    		LD      H,0			; HL= trans(sector)
 213:	3139  224300  		LD	(FSECBUF),HL
 214:	313C  C1      		POP	BC
 215:	313D  E1      		POP	HL
 216:	313E  C9      		RET				; with value in HL
 217:				; sector translation table for 512 bytes/11 sec. track (skew = 4)
 218:	313F  01050902	TRANS:	DEFB	1,5,9,2 		; sectors 1,2,3,4
 219:	3143  060A0307		DEFB	6,10,3,7	 	; sectors 5,6,7,8
 220:	3147  0B0408  		DEFB	11,4,8			; sectors 9,10,11
 221:			
 222:			
 223:	314A          	BLFAILM:
 224:	314A  0D0A424F		DEFB	CR,LF,"BOOT",'!'+$80
	      4F54A1
 225:			;SECTORS DESCS...
 226:	3151  0B00    	FLSECS:	DEFW	11
 227:	3153  0002    		DEFW	512
 228:	3155  0001    	HDSECS:	DEFW	256
 229:	3157  0002    		DEFW	512
 230:	3159  00      	ISHDB:	DEFB	0
 231:	315A  00      	ISVHD:	DEFB	0
 232:			
 233:	0000          		IF	($-BOOTLOAD+1) GT SREFSIZ
 235:				ENDIF
 236:			
 237:	315B          	BMBELOW:
 238:	315B .. 315B 00		DEFS	1
 239:			
 240:			;----------------------------------------------------------------------------
 241:			
 242:	315C          		END



Statistics:

     5	passes
     0	jr promotions
   335	symbols
     0	bytes

     6	macro calls
   108	macro bytes
     0	invented symbols



Symbol Table:

altprnprt      =   3+    crtservdat     =  89+    ppcntrp        =   2+    
appbuf         =  2d+    crtunderbit    =   2+    ppdatap        =   3+    
bbappp         =   e+    crtwidthbit    =   1+    ppdini         =   0+    
bbbase         =f000+    ctc0tc         =  29+    ppdokg         =   2+    
bbcalret       =fd5a+    ctc0tchi       =  20+    ppdrdy         =   4+    
bbcbank        =   c+    ctc1tc         =  28+    ppdstp         =   6+    
bbcomn         =fc00+    ctc1tc100hz    =   5+    ppstrob        =   0+    
bbconin        =fd94+    ctc1tc10hz     =  30+    ppuack         =   7+    
bbconout       =fd9f+    ctc1tc25hz     =  13+    ppuini         =   1+    
bbconst        =fdaa+    ctc1tc2hz      =  f4+    ppuokg         =   3+    
bbcpboot       =fcc3+    ctc1tc50hz     =   a+    ppurdy         =   5+    
bbcrtcini      =fc03+    ctcbase        =  e8+    prntbusybit    =   0+    
bbcrtfill      =fc09+    ctcchan0       =  e8+    prstr           3119     
bbcstck        =   d+    ctcchan1       =  e9+    prvtop         =  4f+    
bbcurset       =fc21+    ctcchan2       =  ea+    r0brdl         =   0+    
bbdebug        =ffff+    ctcchan3       =  eb+    r0rxtx         =   0+    
bbdiv16        =fcdb+    curpbuf        =  48+    r1brdm         =   1+    
bbdmaset       =fcb7+    cursoroff      =  20+    r1ier          =   1+    
bbdprmset      =fd17+    cursoron       =   a+    r2fcr          =   2+    
bbdriveid      =fcf3+    cursshp        =  4a+    r2iir          =   2+    
bbdsksel       =fcbd+    delay          =fd85+    r3lcr          =   3+    
bbeidck        =fd23+    dly1           =fd89+    r4mcr          =   4+    
bbepmngr       =fd1d+    dly2           =fd87+    r5lsr          =   5+    
bbexec         =fd29+    dord            3090     r6msr          =   6+    
bbfdrvsel      =fcd5+    dostx          =fe6f+    r7spr          =   7+    
bbfhome        =fc81+    dselbf         =  4e+    ram0buf        =  3b+    
bbflopio       =fc93+    eep29c         =   4+    ram1buf        =  3c+    
bbfread        =fc87+    eep29ee        =   1+    ram2buf        =  3d+    
bbfwrite       =fc8d+    eep29xe        =   2+    ram3buf        =  3e+    
bbhdboot       =fd0b+    eepage0        =  c0+    ramtbl         =e000+    
bbhdgeo        =fd05+    eeproglock     =  10+    rdide           30c1     
bbhdinit       =fced+    eepsta         =f000+    readcfg8255    =  92+    
bbhdrd         =fcff+    eepunsupp      =   8+    regastatus     =  16+    
bbhdwr         =fcf9+    eerineprom     =  80+    regcommand     =   f+    
bbimgp         =   4+    esc            =  1b+    regcontrol     =  16+    
bbinictc       =fc57+    false          =   0+    regcyllsb      =   c+    
bbldpart       =fd11+    fdcbase        =  d0+    regcylmsb      =   d+    
bbmul16        =fce1+    fdccmdstatr    =  d0+    regdata        =   8+    
bboffcal       =fce7+    fdcdatareg     =  d7+    regerr         =   9+    
bbpag          =   f+    fdcdrvrcnt     =  d6+    regseccnt      =   a+    
bbprcvblk      =fc6f+    fdcreadc       =  88+    regsector      =   b+    
bbprnchr       =fc99+    fdcreset       =  d0+    regshd         =   e+    
bbpsndblk      =fc63+    fdcrestc       =   7+    regstatus      =   f+    
bbrdtime       =fca5+    fdcsectreg     =  d2+    rldrom         =fe85+    
bbrdvdsk       =fc75+    fdcseekc       =  17+    rsrvbuf        =  2f+    
bbresctc       =fc5d+    fdctrakreg     =  d1+    rst7sp1        =  38+    
bbsecset       =fcb1+    fdcwritc       =  a8+    rst7sp2        =  39+    
bbsidset       =fccf+    fdrvbuf        =  45+    rst7sp3        =  3a+    
bbstack        =fec0+    ff             =   c+    rtbsiz         = 3c0+    
bbstbase       =fe9c+    fifblok        =   b+    sconin         =fc2d+    
bbsttim        =fc9f+    fifoend        =  25+    sconout        =fc27+    
bbtrkset       =fcab+    fifokb         =  1a+    sconst         =fc33+    
bbu0ini        =fc39+    fifosto        =   f+    sintvec        =fff0+    
bbu1ini        =fc51+    fifou0         =   f+    size           =2000+    
bbu1rx         =fc45+    fifsize        =   8+    skiprd          30d9+    
bbu1st         =fc4b+    fin            =fdc4+    srefsiz        = 200+    
bbu1tx         =fc3f+    fixblock       =   0+    srxrsm         =fe6d+    
bbuplchr       =fc69+    flsecs          3151     srxstp         =fe69+    
bbvcpmbt       =fcc9+    fout           =fde1+    sysbase        =f000+    
bbvoid         =fd6a+    frdpbuf        =  41+    syscmlo        =fec0+    
bbwrvdsk       =fc7b+    fsecbuf        =  43+    syscom         =fc00+    
bldoffs        =3000+    fsekbuf        =  3f+    syshertz       =  13+    
blfailm         314a     fstat          =fdb5+    sytimr         =fe19+    
blifastblok    =  60+    ftrkbuf        =  46+    tblblk         =  30+    
blifastline    =  6a+    hddma           3125     tdesclen       =  14+    
blini           303f     hdini           3036     tiaddrlen      =   4+    
blislowblok    =  40+    hdsecs          3155     timrcon        =  27+    
blislowline    =  4a+    hdsect          307c     tmpbyte        =  4b+    
blnxts          30dd+    hmempag        =   b+    tnamelen       =   8+    
blsect          3089     idea0line      =   1+    tpa            = 100+    
bmbelow         315b     idea1line      =   2+    tpagelen       =   2+    
bootload        3002     idea2line      =   4+    trans           313f     
bootnok         310d     idecs0line     =   8+    trnpag         =   d+    
brdflo          30b4+    idecs1line     =  10+    true           =ffff+    
brdvrt          30bc     ideporta       =  e0+    tsizelen       =   4+    
btpasiz        =   6+    ideportb       =  e1+    tx0            =fe77+    
cdisk          =   4+    ideportc       =  e2+    tx01           =fe79+    
ckerr           30ca     ideportctrl    =  e3+    u0defspeed     =   6+    
clkio          =   6+    iderdline      =  40+    u0isr          =fe25+    
clkrst         =   7+    iderstline     =  80+    u1defspeed     =   c+    
clksclk        =   5+    idewrline      =  20+    u1isr          =fe5b+    
cmdid          =  ec+    imtpag         =  ff+    u1nul          =fe65+    
cmdinit        =  91+    imtsiz         = 400+    uart0          =  c0+    
cmdread        =  20+    inivh           307b     uart0base      =  c0+    
cmdrecal       =  10+    intrdi         =fe0f+    uart0br        =  2b+    
cmdspindown    =  e0+    intren         =fdfe+    uart1          =  c8+    
cmdspinup      =  e1+    iobyte         =   3+    uart115k2      =   1+    
cmdwrite       =  30+    ishd?              0     uart1200       =  60+    
cnfbyte        =  26+    ishdb           3159     uart19k2       =   6+    
colbuf         =  4f+    isvhd           315a     uart1base      =  c8+    
copsys         =  2c+    isvhd?            36     uart1br        =  2a+    
cr             =   d+    kbdbyte        =  4d+    uart2400       =  30+    
crt6545adst    =  8c+    keybstrbbit    =   7+    uart38k4       =   3+    
crt6545data    =  8d+    lf             =   a+    uart4800       =  18+    
crtbase        =  80+    lsectra         312d     uart57k6       =   2+    
crtbeepport    =  8f+    maxblk         =  14+    uart9600       =   c+    
crtblinkbit    =   0+    menaprt        =  21+    uastav         =fe90+    
crthilitbit    =   3+    miobyte        =  4c+    uastkb         =fe92+    
crtkeybcnt     =  87+    mmgetp         =fd78+    uisre          =fe50+    
crtkeybdat     =  85+    mmpmap         =fd6b+    uisri          =fe35+    
crtmodebit     =   4+    mmtpapag       =  ef+    vconin         =fc15+    
crtprntcnt     =  83+    mmuport        =  20+    vconout        =fc0f+    
crtprntdat     =  81+    mmutstaddr     =d000+    vconst         =fc1b+    
crtram0cnt     =  82+    mmutstpage     =   d+    vdbufsz        =   a+    
crtram0dat     =  80+    monmaj         =  33+    vdrdsec        =   0+    
crtram1cnt     =  86+    monmin         =  34+    vdwrsec        =   1+    
crtram1dat     =  84+    mscnt          =  f6+    vhd             302b     
crtram2cnt     =  8a+    mzmac          =   1+    voidisr        =fe22+    
crtram2dat     =  88+    pio2bit2       =   2+    writecfg8255   =  80+    
crtram3port    =  8e+    pio2bit3       =   3+    xofc           =  13+    
crtrevrsbit    =   1+    pio2bit4       =   4+    xonc           =  11+    
crtservcnt     =  8b+    ppakstb        =   1+    
